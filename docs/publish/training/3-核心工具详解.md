# 第3章 核心工具详解

本章详细介绍各类工具的使用方法、参数说明和输出解读。

---

## 3.1 路径跟踪器系列

路径跟踪器（Path Tracer）是定界问题的核心工具，通过在两个接口上跟踪数据包，判断包在哪一段丢失或延迟。

### 3.1.1 icmp_path_tracer.py

**功能**：跟踪 ICMP 包在指定路径上的四个阶段，定位丢包和延迟位置。

**适用场景**：
- 网络丢包定界（ping 丢包/不通）
- VM 网络延迟初步定界（host 上部署）

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--src-ip` | 是 | 源 IP 地址 | `10.0.0.1` |
| `--dst-ip` | 是 | 目的 IP 地址 | `10.0.0.2` |
| `--rx-iface` | 是 | 入向接口（可逗号分隔多个） | `ens4f0` 或 `ens4f0,ens4f1` |
| `--tx-iface` | 是 | 出向接口 | `vnet0` |
| `--timeout-ms` | 否 | 判定丢包的超时时间（毫秒） | `1000`（默认） |
| `--verbose` | 否 | 输出每个包的详细事件 | - |

**四阶段跟踪模型**：

```
发送端                                              接收端
   │                                                   │
   │  ┌─────────────────────────────────────────────┐  │
   │  │ [0] REQ_RX: Request 到达 rx-iface           │  │
   │  │ [1] REQ_TX: Request 从 tx-iface 发出        │  │
   │  │         -------- 网络传输 --------          │  │
   │  │ [2] REP_RX: Reply 到达 tx-iface             │  │
   │  │ [3] REP_TX: Reply 从 rx-iface 发出          │  │
   │  └─────────────────────────────────────────────┘  │
```

**命令示例**：

```bash
# 系统网络场景
sudo python icmp_path_tracer.py \
    --src-ip 10.132.114.11 --dst-ip 10.132.114.12 \
    --rx-iface ens4f0 --tx-iface bond0

# VM 网络场景
sudo python icmp_path_tracer.py \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --rx-iface ens4f0 --tx-iface vnet0

# Bond 接口场景（多 slave）
sudo python icmp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0,ens4f1 --tx-iface vnet0
```

**状态码含义**：

| 状态码 | 含义 | 可能原因 | 下一步 |
|--------|------|---------|--------|
| `COMPLETE` | 正常完成 | 无问题 | - |
| `EXTERNAL_DROP` | 已发出无回复 | 网络丢包、对端问题 | 检查对端、网络设备 |
| `INTERNAL_DROP_REQ` | 请求未转发 | 本机转发问题 | 检查路由、OVS 规则、防火墙 |
| `INTERNAL_DROP_REP` | 回复未转发 | 本机回复路径问题 | 检查回复路径配置 |

---

### 3.1.2 tcp_path_tracer.py

**功能**：跟踪 TCP 包在指定路径上的四个阶段，使用 seq/ack 匹配包。支持 stats 和 verbose 两种模式。

**适用场景**：
- TCP 连接丢包定界
- TCP 延迟概览（stats 模式）

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--src-ip` | 是 | 源 IP 地址 | `10.0.0.1` |
| `--dst-ip` | 是 | 目的 IP 地址 | `10.0.0.2` |
| `--rx-iface` | 是 | 入向接口 | `ens4f0` |
| `--tx-iface` | 是 | 出向接口 | `vnet0` |
| `--src-port` | 否 | 源端口过滤 | `5201` |
| `--dst-port` | 否 | 目的端口过滤 | `3260` |
| `--timeout-ms` | 否 | 超时时间（毫秒） | `1000` |
| `--stats-mode` | 否 | Stats 模式：周期性 summary 输出 | - |
| `--stats-interval` | 否 | Stats 输出间隔（秒） | `10` |
| `--verbose` | 否 | Verbose 模式：逐包输出 | - |

**双模式**：

```bash
# Stats 模式（推荐，低开销）
sudo python tcp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0 \
    --stats-mode --stats-interval 10

# Stats 输出包含：
# - RX/TX 包数、完成组数、内部丢包数
# - 延迟统计：avg/min/max/P50/P99
# - 延迟直方图

# Verbose 模式（逐包）
sudo python tcp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0 \
    --verbose --src-port 5201
```

**多节点部署定界**：

```bash
# 节点 A（发送端宿主机）
sudo python tcp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0 \
    --stats-mode --stats-interval 10

# 节点 B（接收端宿主机）
sudo python tcp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0 \
    --stats-mode --stats-interval 10

# 定界逻辑：
# - A 有内部丢包 → A 内部问题
# - B 有内部丢包 → B 内部问题
# - 两端都无内部丢包但有 external drop → 网络丢包
```

---

### 3.1.3 udp_path_tracer.py

**功能**：跟踪 UDP 包在指定路径上的单向路径，支持 IP 分片组跟踪。支持 stats 和 verbose 两种模式。

**适用场景**：
- UDP 丢包定界
- 大 UDP 包（分片）丢包分析

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--src-ip` | 是 | 源 IP 地址 | `10.0.0.1` |
| `--dst-ip` | 是 | 目的 IP 地址 | `10.0.0.2` |
| `--rx-iface` | 是 | 入向接口 | `ens4f0` |
| `--tx-iface` | 是 | 出向接口 | `vnet0` |
| `--src-port` | 否 | 源端口过滤 | `12345` |
| `--dst-port` | 否 | 目的端口过滤 | `53` |
| `--stats-mode` | 否 | Stats 模式 | - |
| `--stats-interval` | 否 | Stats 输出间隔（秒） | `10` |
| `--verbose` | 否 | Verbose 模式 | - |

**注意事项**：
- UDP 无连接，只能跟踪单向（RX→TX）
- 需在源端和目的端都部署，合并结果分析
- 支持 IP 分片：同一 IP ID 的分片作为一组跟踪

```bash
# Stats 模式（推荐）
sudo python udp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0 \
    --stats-mode --stats-interval 10

# Verbose 模式
sudo python udp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0 \
    --verbose --dst-port 53
```

---

## 3.2 ICMP RTT 测量工具

### 3.2.1 system_network_icmp_rtt.py

**功能**：测量系统网络（含 OVS 路径）的 ICMP 往返时间，分解各阶段延迟。

**适用场景**：
- 系统网络延迟定界
- OVS 路径延迟分析

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--src-ip` | 是 | 源 IP | `10.132.114.11` |
| `--dst-ip` | 是 | 目的 IP | `10.132.114.12` |
| `--phy-interface` | 是 | 物理接口 | `ens11` |
| `--direction` | 是 | 方向：tx（本机发起）或 rx（对端发起） | `tx` |
| `--latency-ms` | 否 | 延迟阈值过滤（毫秒） | `10` |
| `--disable-kernel-stacks` | 否 | 禁用内核栈输出 | - |

**命令示例**：

```bash
# TX 模式：本机 ping 对端
sudo python system_network_icmp_rtt.py \
    --src-ip 10.132.114.11 --dst-ip 10.132.114.12 \
    --phy-interface ens11 --direction tx

# RX 模式：对端 ping 本机
sudo python system_network_icmp_rtt.py \
    --src-ip 10.132.114.12 --dst-ip 10.132.114.11 \
    --phy-interface ens11 --direction rx

# 只显示延迟 > 10ms 的包
sudo python system_network_icmp_rtt.py \
    --src-ip 10.132.114.11 --dst-ip 10.132.114.12 \
    --phy-interface ens11 --direction tx --latency-ms 10
```

**阶段含义**：

| 阶段 | 含义 | 高延迟可能原因 |
|------|------|---------------|
| ip_local_out → netif_receive_skb | 本地发送到 OVS | OVS 处理瓶颈 |
| netif_receive_skb → ip_rcv | OVS 到 IP 层 | ksoftirqd 调度 |
| ip_rcv → net_dev_xmit | IP 层到网卡发送 | 驱动/队列问题 |
| netif_receive_skb → icmp_rcv | 接收到 ICMP 处理 | 协议栈处理 |
| WIRE_TIME | 网络传输时间 | 物理网络问题 |

---

### 3.2.2 kernel_icmp_rtt.py

**功能**：测量内核态 ICMP RTT（不含 OVS），适合 VM 内部或 VM 网络场景配合 path_tracer 使用。

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--src-ip` | 是 | 源 IP | `172.21.153.113` |
| `--dst-ip` | 是 | 目的 IP | `172.21.153.114` |
| `--interface` | 是 | 接口（可逗号分隔） | `ens4f0` |
| `--direction` | 是 | 方向：tx 或 rx | `tx` |
| `--latency-ms` | 否 | 延迟阈值 | `5` |

```bash
# 基本用法
sudo python kernel_icmp_rtt.py \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --interface ens4f0 --direction tx

# Bond 场景
sudo python kernel_icmp_rtt.py \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --interface ens4f0,ens4f1 --direction tx
```

---

## 3.3 延迟统计与详情工具

### 3.3.1 system_network_latency_summary.py

**功能**：统计系统网络各阶段延迟的直方图分布。

**适用场景**：长期监控，建立性能基线，初步筛查延迟异常

**开销**：低（内核态聚合）

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--phy-interface` | 是 | 物理接口 | `ens11` |
| `--src-ip` | 否 | 源 IP 过滤 | `10.0.0.1` |
| `--dst-ip` | 否 | 目的 IP 过滤 | `10.0.0.2` |
| `--protocol` | 否 | 协议过滤 | `tcp` / `udp` / `icmp` / `all` |
| `--direction` | 是 | 方向 | `rx` / `tx` / `both` |
| `--interval` | 否 | 输出间隔（秒） | `5` |

```bash
sudo python system_network_latency_summary.py \
    --phy-interface ens11 --protocol tcp --direction rx --interval 5
```

**直方图解读**：
- 正常：大部分落在低延迟 bucket
- 异常：高延迟 bucket（如 64-127us、128-255us）有计数
- 下一步：记录异常时段，使用 Details 工具精确分析

### 3.3.2 vm_network_latency_summary.py

**功能**：统计 VM 网络各阶段延迟的直方图分布。

**开销**：低

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--vm-interface` | 是 | VM 接口（vnet/tap） | `vnet0` |
| `--phy-interface` | 是 | 物理接口 | `ens4f0` |
| `--src-ip` | 否 | 源 IP 过滤 | `172.21.153.113` |
| `--dst-ip` | 否 | 目的 IP 过滤 | `172.21.153.114` |
| `--protocol` | 否 | 协议过滤 | `tcp` |
| `--direction` | 是 | 方向 | `rx` / `tx` |
| `--interval` | 否 | 输出间隔（秒） | `5` |

```bash
sudo python vm_network_latency_summary.py \
    --vm-interface vnet0 --phy-interface ens4f0 \
    --protocol tcp --direction rx --interval 5
```

### 3.3.3 *_latency_details.py

**功能**：逐包输出详细延迟信息。

**开销**：取决于过滤后事件速率（见第2章 2.1 节）

**使用前提**：
1. 已运行 Summary 工具，识别异常
2. 已提取过滤条件（src-ip、dst-ip、protocol）
3. 可配合 `--latency-ms` 进一步控制事件速率

```bash
# 系统网络
sudo python system_network_latency_details.py \
    --phy-interface ens11 \
    --src-ip 10.132.114.11 --dst-ip 10.132.114.12 \
    --protocol tcp --direction rx

# VM 网络
sudo python vm_network_latency_details.py \
    --vm-interface vnet0 --phy-interface ens4f0 \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --protocol tcp --direction rx
```

---

## 3.4 通用丢包工具

### 3.4.1 eth_drop.py

**功能**：通用以太网层丢包检测，输出丢包位置和内核调用栈。

**开销**：低（仅跟踪丢包事件）

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--interface` | 否 | 接口过滤 | `ens4f0` |
| `--src-ip` | 否 | 源 IP 过滤 | `10.0.0.1` |
| `--dst-ip` | 否 | 目的 IP 过滤 | `10.0.0.2` |

```bash
# 监控所有丢包
sudo python eth_drop.py

# 指定 IP 对
sudo python eth_drop.py --src-ip 10.0.0.1 --dst-ip 10.0.0.2
```

**输出示例**：

```
TIME        INTERFACE  PROTO  SRC_IP:PORT -> DST_IP:PORT  REASON     LOCATION
14:50:23    ens4f0     TCP    10.0.0.1:5201 -> 10.0.0.2:3260  NOT_SPECIFIED  kfree_skb
  Stack:
    kfree_skb+0x1
    tcp_v4_rcv+0x1a3
    ip_local_deliver_finish+0x73
    ...
```

**常见 REASON**：

| Reason | 含义 | 可能原因 |
|--------|------|---------|
| `NOT_SPECIFIED` | 未指定原因 | 需看调用栈分析 |
| `NO_SOCKET` | 无对应 socket | 端口未监听 |
| `TCP_RESET` | TCP RST | 连接被重置 |
| `NETFILTER_DROP` | 被防火墙丢弃 | iptables 规则 |

### 3.4.2 kernel_drop_stack_stats_summary_all.py

**功能**：按内核调用栈聚合丢包统计，识别丢包热点。

**开销**：低

```bash
sudo python kernel_drop_stack_stats_summary_all.py --interval 5
```

**分析方法**：
1. 找到 Count 最高的调用栈
2. 查看调用栈中的函数（如 `tcp_v4_rcv`）
3. 结合内核代码分析丢包原因
4. 上报开发团队进一步分析

### 3.4.3 qdisc_drop_trace.py

**功能**：跟踪 qdisc 队列层丢包。

**适用场景**：网卡发送队列满导致的丢包

```bash
sudo python qdisc_drop_trace.py
```

---

## 3.5 综合性能指标工具

### 3.5.1 system_network_perfomance_metrics.py

**功能**：综合系统网络性能跟踪，覆盖多个内核网络函数的延迟和调用统计。

**适用场景**：系统网络整体性能评估

```bash
sudo python system_network_perfomance_metrics.py \
    --phy-interface ens11 \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --protocol tcp --direction rx
```

### 3.5.2 vm_network_performance_metrics.py

**功能**：综合 VM 网络性能跟踪，覆盖虚拟化网络路径各阶段。

**适用场景**：VM 网络整体性能评估

```bash
sudo python vm_network_performance_metrics.py \
    --vm-interface vnet0 --phy-interface ens4f0 \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --protocol tcp --direction rx
```

---

## 3.6 OVS 相关工具

### 3.6.1 ovs_upcall_latency_summary.py

**功能**：监控 OVS upcall 延迟分布（flow miss 导致的 upcall 处理延迟）。

**适用场景**：
- OVS 首包延迟分析
- flow table miss 频率评估

**开销**：低

```bash
sudo python ovs_upcall_latency_summary.py --interval 5
```

### 3.6.2 ovs_userspace_megaflow.py

**功能**：跟踪 OVS userspace megaflow 安装和匹配情况。

**适用场景**：
- megaflow 规则安装问题
- flow table 性能分析

```bash
sudo python ovs_userspace_megaflow.py
```

### 3.6.3 ovs-kernel-module-drop-monitor.py

**功能**：监控 OVS 内核模块丢包，包含 conntrack 状态跟踪。

**适用场景**：
- OVS 内核模块导致的丢包
- conntrack 状态异常

```bash
sudo python ovs-kernel-module-drop-monitor.py
```

### 3.6.4 ovs_mcast_action_trace.py

**功能**：跟踪 OVS 多播 action 处理（IPv6）。

**适用场景**：IPv6 多播相关问题

```bash
sudo python ovs_mcast_action_trace.py
```

---

## 3.7 内核协议栈工具

### 3.7.1 trace_conntrack.py

**功能**：跟踪 netfilter conntrack 连接跟踪事件。

**适用场景**：
- conntrack 表项创建/销毁分析
- 连接跟踪状态异常

```bash
sudo python trace_conntrack.py
```

### 3.7.2 trace_ip_defrag.py

**功能**：跟踪 IP 分片和重组过程。

**适用场景**：
- IP 分片重组问题
- 分片丢包分析

```bash
sudo python trace_ip_defrag.py
```

### 3.7.3 kernel_drop_stack_stats_summary.py

**功能**：带过滤的 kfree_skb 调用栈统计（直方图）。

**适用场景**：针对特定接口或 IP 的丢包栈分析

```bash
sudo python kernel_drop_stack_stats_summary.py --interface ens4f0
```

---

## 3.8 KVM 虚拟化网络工具

KVM 虚拟化网络栈从上到下：KVM（中断注入）→ vhost-net（内核加速）→ TUN/TAP（设备层）→ virtio-net（Guest 驱动）。

### 3.8.1 KVM 中断统计

#### kvm_irqfd_stats_summary.py

**功能**：统计 VM 中断注入频率和分布（x86 架构）。

**适用场景**：
- VM 中断风暴分析
- 中断注入性能评估

```bash
sudo python kvm_irqfd_stats_summary.py
```

#### kvm_irqfd_stats_summary_arm.py

**功能**：ARM 架构版本的 KVM 中断统计。

```bash
sudo python kvm_irqfd_stats_summary_arm.py
```

### 3.8.2 vhost-net 工具

#### vhost_queue_correlation_simple.py

**功能**：监控 vhost-net 队列关联状态（简单模式）。

**适用场景**：vhost 队列映射问题排查

```bash
sudo python vhost_queue_correlation_simple.py --vm-interface vnet0
```

#### vhost_queue_correlation_details.py

**功能**：详细的 vhost 队列关联监控。

**适用场景**：深入分析 vhost 队列处理

```bash
sudo python vhost_queue_correlation_details.py --vm-interface vnet0
```

#### vhost_buf_peek_stats.py

**功能**：跟踪 vhost_net_buf_peek 返回值统计。

**适用场景**：vhost buffer 处理异常分析

```bash
sudo python vhost_buf_peek_stats.py
```

#### kvm_vhost_tun_latency_summary.py（dev 分支）

**功能**：KVM-vhost-TUN 完整虚拟化路径延迟统计。

**适用场景**：虚拟化网络栈各阶段延迟分析

```bash
sudo python kvm_vhost_tun_latency_summary.py
```

#### kvm_vhost_tun_latency_details.py（dev 分支）

**功能**：KVM-vhost-TUN 延迟逐包详情。

```bash
sudo python kvm_vhost_tun_latency_details.py
```

#### vhost_wakeup_latency.py（dev 分支）

**功能**：测量 vhost worker 唤醒调度延迟。

**适用场景**：vhost 线程调度异常导致的延迟

```bash
sudo python vhost_wakeup_latency.py
```

### 3.8.3 TUN/TAP 工具

#### tun_ring_monitor.py

**功能**：监控 TUN 设备 ptr_ring 缓冲区状态。

**适用场景**：
- TUN 设备缓冲区溢出分析
- ring 满导致的丢包

```bash
sudo python tun_ring_monitor.py --interface tap0
```

#### tun_tx_to_kvm_irq.py（dev 分支）

**功能**：跟踪 TUN TX 包到 KVM 中断注入的完整链路延迟。

**适用场景**：中断注入延迟定位

```bash
sudo python tun_tx_to_kvm_irq.py
```

#### tun_to_vhost_queue_stats_full_summary.py

**功能**：TUN 到 vhost 队列关联的完整统计。

```bash
sudo python tun_to_vhost_queue_stats_full_summary.py
```

### 3.8.4 virtio-net 工具（VM 内部署）

#### virtnet_poll_monitor.py

**功能**：监控 virtnet_poll 调用频率和批量大小。

**适用场景**：VM 内 NAPI polling 性能分析

```bash
sudo python virtnet_poll_monitor.py --interface eth0
```

#### virtnet_irq_monitor.py

**功能**：监控 virtio-net 中断，包含 CPU 亲和性跟踪。

**适用场景**：VM 内中断分布和 CPU 绑定分析

```bash
sudo python virtnet_irq_monitor.py
```

---

## 3.9 CPU 与调度工具

### 3.9.1 offcputime-ts.py

**功能**：Off-CPU 时间分析，输出线程被调度出去的时间和调用栈。

**适用场景**：
- 线程调度延迟分析
- 定位阻塞原因

```bash
sudo python offcputime-ts.py
```

### 3.9.2 vhost_wakeup_latency.py（dev 分支）

**功能**：测量 vhost worker 线程的调度唤醒延迟。

**适用场景**：vhost 线程被调度延迟导致的网络延迟

```bash
sudo python vhost_wakeup_latency.py
```

### 3.9.3 bpftrace 脚本

| 脚本 | 功能 |
|------|------|
| `futex.bt` | Futex 系统调用延迟直方图 |
| `pthread_rwlock_wrlock.bt` | pthread 读写锁写锁延迟 |
| `pthread_rwlock_wrlock-stack.bt` | pthread 读写锁写锁调用栈统计 |

```bash
sudo bpftrace futex.bt
sudo bpftrace pthread_rwlock_wrlock.bt
```

---

## 3.10 TCP 性能分析工具（dev 分支）

### 3.10.1 tcp_perf_observer.py

**功能**：TCP 连接性能观测，监控 RTT、握手、拥塞控制。

**适用场景**：TCP 传输性能问题

```bash
sudo python tcp_perf_observer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2
```

### 3.10.2 tcp_connection_analyzer.py

**功能**：TCP 连接状态分析，检测瓶颈。

**适用场景**：连接建立/关闭问题

```bash
sudo python tcp_connection_analyzer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2
```

### 3.10.3 tcp_rtt_inflight_hist.py / tcp_send_rtt_inflight_hist.py

**功能**：TCP RTT 与 in-flight 包数、拥塞窗口的直方图关联分析。

**适用场景**：TCP 拥塞分析

```bash
# 接收视角
sudo python tcp_rtt_inflight_hist.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2

# 发送视角
sudo python tcp_send_rtt_inflight_hist.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2
```

### 3.10.4 syscall_recv_latency_summary.py

**功能**：recv/read 系统调用延迟统计。

**适用场景**：应用层接收延迟分析

```bash
sudo python syscall_recv_latency_summary.py
```

---

## 3.11 VXLAN 工具（dev 分支）

### 3.11.1 vxlan_tracer.py

**功能**：VXLAN 封装/解封装过程跟踪。

**适用场景**：VXLAN overlay 网络问题

```bash
sudo python vxlan_tracer.py
```

### 3.11.2 skb_vxlan_source_detector.py

**功能**：检测 VXLAN gso_type 标记的来源。

**适用场景**：VXLAN 包来源追溯

```bash
sudo python skb_vxlan_source_detector.py
```

---

## 3.12 VM Pair 延迟分析工具（dev 分支）

### 3.12.1 vm_pair_latency.py

**功能**：单 VM 对延迟测量。

```bash
sudo python vm_pair_latency.py \
    --vm-interface vnet0 --phy-interface ens4f0
```

### 3.12.2 multi_vm_pair_latency.py

**功能**：多 VM 对同时监控延迟。

**适用场景**：批量 VM 延迟监控

```bash
sudo python multi_vm_pair_latency.py
```

### 3.12.3 vm_pair_gap.py

**功能**：VM 对延迟间隙（gap）分析，检测延迟突增。

**适用场景**：间歇性延迟突增问题

```bash
sudo python vm_pair_gap.py \
    --vm-interface vnet0 --phy-interface ens4f0
```

---

## 3.13 OVS Internal Port 工具（dev 分支）

### 3.13.1 enqueue_to_iprec_latency_summary.py

**功能**：OVS internal port RX 路径延迟测量。

```bash
sudo python enqueue_to_iprec_latency_summary.py
```

### 3.13.2 ksoftirqd_sched_latency_summary.py

**功能**：ksoftirqd 调度延迟测量。

**适用场景**：软中断调度延迟导致的网络延迟

```bash
sudo python ksoftirqd_sched_latency_summary.py
```

---

## 3.14 其他辅助工具

### 3.14.1 iface_netstat.py

**功能**：接口网络统计监控。

```bash
sudo python iface_netstat.py --interface ens4f0
```

### 3.14.2 deploy_full_mesh_icmp_tracer.py

**功能**：批量部署 ICMP RTT 跟踪器（full mesh）。

**适用场景**：多节点间全网格延迟测量

```bash
sudo python deploy_full_mesh_icmp_tracer.py
```

### 3.14.3 drop_monitor_controller.py

**功能**：条件触发的丢包监控控制器，当丢包率超阈值时自动启动 eth_drop。

```bash
sudo python drop_monitor_controller.py
```

### 3.14.4 phy_net_drop_detector.py

**功能**：物理网络丢包检测，使用双端 UDP 探测。

```bash
sudo python phy_net_drop_detector.py
```

### 3.14.5 bpftrace 脚本汇总

| 脚本 | 功能 | 位置 |
|------|------|------|
| `trace-abnormal-arp.bt` | 异常 ARP 包检测 | other/ |
| `trace-ovs-ct-invalid.bt` | OVS conntrack invalid 包跟踪 | other/ |
| `trace-qdisc-dequeue.bt` | qdisc 出队跟踪（含 GSO 状态） | other/ |
| `trace_dev_queue_xmit.bt` | 设备队列发送跟踪 | other/ |
| `trace_offloading_segment.bt` | IP tunnel offload 和分段跟踪 | other/ |
| `trace_tc_qdisc.bt` | TC qdisc 详细包检查 | other/ |
| `kernel_drop_stack_stats.bt` | 带设备过滤的 kfree_skb 栈统计 | linux-network-stack/ |
| `tun-abnormal-gso-type.bt` | TUN 异常 GSO 类型检测 | kvm-virt-network/tun/ |
| `tun-tx-ring-stas.bt` | TUN TX ring 状态统计 | kvm-virt-network/tun/ |
| `vhost_eventfd_count.bt` | vhost eventfd 计数 | kvm-virt-network/vhost-net/ |
| `trace_int_final.bt` | IRQ 处理和 vring 中断统计 | kvm-virt-network/virtio-net/ |
| `virtionet-rx-path-monitor.bt` | VM RX 路径函数跟踪 | kvm-virt-network/virtio-net/ |
| `virtionet-rx-path-summary.bt` | virtio-net RX 路径综合监控 | kvm-virt-network/virtio-net/ |
| `virtnet_poll_stack_stats.bt` | virtnet_poll 调用栈统计 | kvm-virt-network/virtio-net/ |
