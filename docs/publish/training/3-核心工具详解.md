# 第3章 核心工具详解

本章详细介绍每类核心工具的使用方法、参数说明和输出解读。

---

## 3.1 路径跟踪器系列

路径跟踪器（Path Tracer）是定界问题的核心工具，通过在两个接口上跟踪数据包，判断包在哪一段丢失或延迟。

### 3.1.1 icmp_path_tracer.py

**功能**：跟踪 ICMP 包在指定路径上的四个阶段，定位丢包位置。

**适用场景**：
- 网络丢包定界（ping 丢包/不通）
- VM 网络延迟初步定界

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--src-ip` | 是 | 源 IP 地址 | `10.0.0.1` |
| `--dst-ip` | 是 | 目的 IP 地址 | `10.0.0.2` |
| `--rx-iface` | 是 | 入向接口（可逗号分隔多个） | `ens4f0` 或 `ens4f0,ens4f1` |
| `--tx-iface` | 是 | 出向接口 | `vnet0` |
| `--timeout-ms` | 否 | 判定丢包的超时时间（毫秒） | `1000`（默认） |

**四阶段跟踪模型**：

```
发送端                                              接收端
   │                                                   │
   │  ┌─────────────────────────────────────────────┐  │
   │  │ [0] REQ_RX: Request 到达 rx-iface           │  │
   │  │ [1] REQ_TX: Request 从 tx-iface 发出        │  │
   │  │         -------- 网络传输 --------          │  │
   │  │ [2] REP_RX: Reply 到达 tx-iface             │  │
   │  │ [3] REP_TX: Reply 从 rx-iface 发出          │  │
   │  └─────────────────────────────────────────────┘  │
```

**命令示例**：

```bash
# 系统网络场景
sudo python icmp_path_tracer.py \
    --src-ip 10.132.114.11 --dst-ip 10.132.114.12 \
    --rx-iface ens4f0 --tx-iface bond0

# VM 网络场景
sudo python icmp_path_tracer.py \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --rx-iface ens4f0 --tx-iface vnet0

# Bond 接口场景（多 slave）
sudo python icmp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0,ens4f1 --tx-iface vnet0
```

**输出解读**：

```
=== ICMP Path Tracer ===
RX interfaces: ens4f0 (ifindex=3)
TX interfaces: vnet0 (ifindex=15)
Filter: 10.0.0.1 <-> 10.0.0.2
Timeout: 1000ms

[14:32:15.123456] ICMP id=1234 seq=1
  [0] REQ_RX  ens4f0   ktime=1234567890123
  [1] REQ_TX  vnet0    ktime=1234567890456  delta=333us
  [2] REP_RX  vnet0    ktime=1234568100789  delta=210ms
  [3] REP_TX  ens4f0   ktime=1234568101012  delta=223us
  STATUS: COMPLETE  TOTAL_TIME=211ms

[14:32:16.125678] ICMP id=1234 seq=2
  [0] REQ_RX  ens4f0   ktime=1234667890123
  [1] REQ_TX  vnet0    ktime=1234667890456  delta=333us
  STATUS: EXTERNAL_DROP (missing REP_RX after 1000ms)

[14:32:17.127890] ICMP id=1234 seq=3
  [0] REQ_RX  ens4f0   ktime=1234767890123
  STATUS: INTERNAL_DROP_REQ (missing REQ_TX after 1000ms)
```

**状态码含义**：

| 状态码 | 含义 | 可能原因 | 下一步 |
|--------|------|---------|--------|
| `COMPLETE` | 正常完成 | 无问题 | - |
| `EXTERNAL_DROP` | 已发出无回复 | 网络丢包、对端问题 | 检查对端、网络设备 |
| `INTERNAL_DROP_REQ` | 请求未转发 | 本机转发问题 | 检查路由、OVS 规则、防火墙 |
| `INTERNAL_DROP_REP` | 回复未转发 | 本机回复路径问题 | 检查回复路径配置 |

---

### 3.1.2 tcp_path_tracer.py

**功能**：跟踪 TCP 包在指定路径上的四个阶段，使用 seq/ack 匹配包。

**适用场景**：
- TCP 连接丢包定界
- TCP 重传问题定位

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--src-ip` | 是 | 源 IP 地址 | `10.0.0.1` |
| `--dst-ip` | 是 | 目的 IP 地址 | `10.0.0.2` |
| `--rx-iface` | 是 | 入向接口 | `ens4f0` |
| `--tx-iface` | 是 | 出向接口 | `vnet0` |
| `--src-port` | 否 | 源端口过滤 | `5201` |
| `--dst-port` | 否 | 目的端口过滤 | `3260` |
| `--timeout-ms` | 否 | 超时时间（毫秒） | `1000` |

**命令示例**：

```bash
# 基本用法
sudo python tcp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0

# 指定端口（建议）
sudo python tcp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0 \
    --src-port 5201

# iSCSI 场景
sudo python tcp_path_tracer.py \
    --src-ip 172.21.153.100 --dst-ip 172.21.153.200 \
    --rx-iface ens4f0 --tx-iface vnet0 \
    --dst-port 3260
```

**多节点部署定界**：

```bash
# 节点 A（发送端宿主机）
sudo python tcp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0 --src-port 5201

# 节点 B（接收端宿主机）
sudo python tcp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0 --src-port 5201

# 定界逻辑：
# - A 有 [1] REQ_TX，B 无 [0] REQ_RX → 网络丢包
# - A 有 [0] 无 [1] → A 内部丢包
# - B 有 [0] 无 [1] → B 内部丢包
```

**输出解读**：

```
[14:35:22.456] TCP 10.0.0.1:5201 -> 10.0.0.2:3260 seq=1234567890 len=1460
  [0] REQ_RX  ens4f0   ktime=...
  [1] REQ_TX  vnet0    ktime=...  delta=125us
  [2] REP_RX  vnet0    ktime=...  delta=1.2ms  (ACK=1234569350)
  [3] REP_TX  ens4f0   ktime=...  delta=45us
  STATUS: COMPLETE
```

---

### 3.1.3 udp_path_tracer.py

**功能**：跟踪 UDP 包在指定路径上的单向路径，支持 IP 分片组跟踪。

**适用场景**：
- UDP 丢包定界
- 大 UDP 包（分片）丢包分析

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--src-ip` | 是 | 源 IP 地址 | `10.0.0.1` |
| `--dst-ip` | 是 | 目的 IP 地址 | `10.0.0.2` |
| `--rx-iface` | 是 | 入向接口 | `ens4f0` |
| `--tx-iface` | 是 | 出向接口 | `vnet0` |
| `--src-port` | 否 | 源端口过滤 | `12345` |
| `--dst-port` | 否 | 目的端口过滤 | `53` |

**注意事项**：
- UDP 无连接，只能跟踪单向（RX→TX）
- 需在源端和目的端都部署，合并结果分析
- 支持 IP 分片：同一 IP ID 的分片作为一组跟踪

**命令示例**：

```bash
# 基本用法
sudo python udp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0

# DNS 场景
sudo python udp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.53 \
    --rx-iface ens4f0 --tx-iface vnet0 \
    --dst-port 53
```

---

## 3.2 延迟测量工具

### 3.2.1 system_network_icmp_rtt.py

**功能**：测量系统网络（含 OVS 路径）的 ICMP 往返时间，分解各阶段延迟。

**适用场景**：
- 系统网络延迟定界
- OVS 路径延迟分析

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--src-ip` | 是 | 源 IP | `10.132.114.11` |
| `--dst-ip` | 是 | 目的 IP | `10.132.114.12` |
| `--phy-interface` | 是 | 物理接口 | `ens11` |
| `--direction` | 是 | 方向：tx（本机发起）或 rx（对端发起） | `tx` |
| `--latency-ms` | 否 | 延迟阈值过滤（毫秒） | `10` |

**命令示例**：

```bash
# TX 模式：本机 ping 对端
sudo python system_network_icmp_rtt.py \
    --src-ip 10.132.114.11 --dst-ip 10.132.114.12 \
    --phy-interface ens11 --direction tx

# RX 模式：对端 ping 本机
sudo python system_network_icmp_rtt.py \
    --src-ip 10.132.114.12 --dst-ip 10.132.114.11 \
    --phy-interface ens11 --direction rx

# 只显示延迟 > 10ms 的包
sudo python system_network_icmp_rtt.py \
    --src-ip 10.132.114.11 --dst-ip 10.132.114.12 \
    --phy-interface ens11 --direction tx --latency-ms 10
```

**输出解读**：

```
=== System Network ICMP RTT Tracer ===
Direction: TX (local ping remote)
Physical interface: ens11 (ifindex=5)
Filter: 10.132.114.11 -> 10.132.114.12

[14:40:15.123] seq=1 TOTAL_RTT=245us
  TX Path:
    ip_local_out           ->  netif_receive_skb:   45us
    netif_receive_skb      ->  ip_rcv:              12us
    ip_rcv                 ->  net_dev_xmit:        28us
  RX Path:
    netif_receive_skb      ->  icmp_rcv:            35us
  WIRE_TIME (estimated): 125us

[14:40:16.125] seq=2 TOTAL_RTT=1523us  <<<< HIGH LATENCY
  TX Path:
    ip_local_out           ->  netif_receive_skb:   42us
    netif_receive_skb      ->  ip_rcv:            1105us  <<<< BOTTLENECK
    ip_rcv                 ->  net_dev_xmit:        31us
  ...
```

**阶段含义**：

| 阶段 | 含义 | 高延迟可能原因 |
|------|------|---------------|
| ip_local_out → netif_receive_skb | 本地发送到 OVS | OVS 处理瓶颈 |
| netif_receive_skb → ip_rcv | OVS 到 IP 层 | ksoftirqd 调度 |
| ip_rcv → net_dev_xmit | IP 层到网卡发送 | 驱动/队列问题 |
| netif_receive_skb → icmp_rcv | 接收到 ICMP 处理 | 协议栈处理 |
| WIRE_TIME | 网络传输时间 | 物理网络问题 |

---

### 3.2.2 kernel_icmp_rtt.py

**功能**：测量内核态 ICMP RTT（不含 OVS），适合 VM 网络场景配合 path_tracer 使用。

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--src-ip` | 是 | 源 IP | `172.21.153.113` |
| `--dst-ip` | 是 | 目的 IP | `172.21.153.114` |
| `--interface` | 是 | 接口（可逗号分隔） | `ens4f0` |
| `--direction` | 是 | 方向：tx 或 rx | `tx` |
| `--latency-ms` | 否 | 延迟阈值 | `5` |

**命令示例**：

```bash
# 基本用法
sudo python kernel_icmp_rtt.py \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --interface ens4f0 --direction tx

# Bond 场景
sudo python kernel_icmp_rtt.py \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --interface ens4f0,ens4f1 --direction tx
```

---

### 3.2.3 system_network_latency_summary.py

**功能**：统计系统网络各阶段延迟的直方图分布。

**适用场景**：
- 长期监控，建立性能基线
- 初步筛查延迟异常时段/阶段

**开销**：低（内核态聚合）

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--phy-interface` | 是 | 物理接口 | `ens11` |
| `--src-ip` | 否 | 源 IP 过滤 | `10.0.0.1` |
| `--dst-ip` | 否 | 目的 IP 过滤 | `10.0.0.2` |
| `--protocol` | 否 | 协议过滤 | `tcp` / `udp` / `icmp` / `all` |
| `--direction` | 是 | 方向 | `rx` / `tx` / `both` |
| `--interval` | 否 | 输出间隔（秒） | `5` |

**命令示例**：

```bash
# 监控所有 TCP 接收流量
sudo python system_network_latency_summary.py \
    --phy-interface ens11 --protocol tcp --direction rx --interval 5

# 指定 IP 对监控
sudo python system_network_latency_summary.py \
    --phy-interface ens11 \
    --src-ip 10.132.114.11 --dst-ip 10.132.114.12 \
    --protocol tcp --direction rx --interval 5
```

**输出解读**：

```
=== System Network Latency Summary ===
Interval: 5s | Protocol: TCP | Direction: RX

[14:45:00] Stage: netif_receive_skb -> ip_rcv
     usecs               : count     distribution
         0 -> 1          : 1523     |********                        |
         2 -> 3          : 4521     |************************        |
         4 -> 7          : 6234     |********************************|
         8 -> 15         : 2341     |************                    |
        16 -> 31         : 523      |**                              |
        32 -> 63         : 45       |                                |
        64 -> 127        : 12       |                                |  <<<< 异常
       128 -> 255        : 3        |                                |  <<<< 异常

[14:45:00] Stage: ip_rcv -> tcp_v4_rcv
     usecs               : count     distribution
         0 -> 1          : 8234     |********************************|
         2 -> 3          : 3421     |*************                   |
         ...
```

**直方图解读**：
- 正常：大部分落在低延迟 bucket
- 异常：出现高延迟 bucket 有计数（如 64-127us、128-255us）
- 下一步：记录异常时段，使用 Details 工具精确分析

---

### 3.2.4 vm_network_latency_summary.py

**功能**：统计 VM 网络各阶段延迟的直方图分布。

**适用场景**：
- VM 网络长期监控
- 初步筛查 VM 网络延迟问题

**开销**：低

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--vm-interface` | 是 | VM 接口（vnet/tap） | `vnet0` |
| `--phy-interface` | 是 | 物理接口 | `ens4f0` |
| `--src-ip` | 否 | 源 IP 过滤 | `172.21.153.113` |
| `--dst-ip` | 否 | 目的 IP 过滤 | `172.21.153.114` |
| `--protocol` | 否 | 协议过滤 | `tcp` |
| `--direction` | 是 | 方向 | `rx` / `tx` |
| `--interval` | 否 | 输出间隔（秒） | `5` |

**命令示例**：

```bash
sudo python vm_network_latency_summary.py \
    --vm-interface vnet0 --phy-interface ens4f0 \
    --protocol tcp --direction rx --interval 5
```

---

### 3.2.5 *_latency_details.py（高开销）

**功能**：逐包输出详细延迟信息。

**开销**：**高**，必须使用过滤条件

**使用前提**：
1. 已运行 Summary 工具，识别异常
2. 已提取过滤条件（src-ip、dst-ip、protocol）
3. 已评估过滤后流量 PPS

**命令示例**：

```bash
# 系统网络
sudo python system_network_latency_details.py \
    --phy-interface ens11 \
    --src-ip 10.132.114.11 --dst-ip 10.132.114.12 \
    --protocol tcp --direction rx

# VM 网络
sudo python vm_network_latency_details.py \
    --vm-interface vnet0 --phy-interface ens4f0 \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --protocol tcp --direction rx
```

---

## 3.3 通用丢包工具

### 3.3.1 eth_drop.py

**功能**：通用以太网层丢包检测，输出丢包位置和内核调用栈。

**适用场景**：
- 协议不明的丢包问题
- 需要查看丢包调用栈
- 初步定位丢包热点

**开销**：低（仅跟踪丢包事件）

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--interface` | 否 | 接口过滤 | `ens4f0` |
| `--src-ip` | 否 | 源 IP 过滤 | `10.0.0.1` |
| `--dst-ip` | 否 | 目的 IP 过滤 | `10.0.0.2` |

**命令示例**：

```bash
# 监控所有丢包
sudo python eth_drop.py

# 指定接口
sudo python eth_drop.py --interface ens4f0

# 指定 IP 对
sudo python eth_drop.py --src-ip 10.0.0.1 --dst-ip 10.0.0.2
```

**输出解读**：

```
TIME        INTERFACE  PROTO  SRC_IP:PORT -> DST_IP:PORT  REASON     LOCATION
14:50:23    ens4f0     TCP    10.0.0.1:5201 -> 10.0.0.2:3260  NOT_SPECIFIED  kfree_skb
  Stack:
    kfree_skb+0x1
    tcp_v4_rcv+0x1a3
    ip_local_deliver_finish+0x73
    ...

14:50:24    vnet0      UDP    10.0.0.1:12345 -> 10.0.0.2:53   NO_SOCKET      kfree_skb
  Stack:
    kfree_skb+0x1
    udp_rcv+0x234
    ...
```

**常见 REASON**：

| Reason | 含义 | 可能原因 |
|--------|------|---------|
| `NOT_SPECIFIED` | 未指定原因 | 需看调用栈分析 |
| `NO_SOCKET` | 无对应 socket | 端口未监听 |
| `TCP_RESET` | TCP RST | 连接被重置 |
| `NETFILTER_DROP` | 被防火墙丢弃 | iptables 规则 |

---

### 3.3.2 kernel_drop_stack_stats_summary_all.py

**功能**：按内核调用栈聚合丢包统计，识别丢包热点。

**适用场景**：
- 分析丢包模式
- 识别高频丢包路径
- 配合内核代码分析定位根因

**开销**：低

**参数说明**：

| 参数 | 必填 | 说明 | 示例 |
|------|------|------|------|
| `--interval` | 否 | 输出间隔（秒） | `5` |

**命令示例**：

```bash
sudo python kernel_drop_stack_stats_summary_all.py --interval 5
```

**输出解读**：

```
=== Kernel Drop Stack Statistics ===
Interval: 5s

[14:55:00] Top drop stacks:

Count: 1523
  kfree_skb
  tcp_v4_rcv
  ip_local_deliver_finish
  ip_local_deliver
  ip_rcv_finish
  ip_rcv

Count: 234
  kfree_skb
  udp_rcv
  ip_local_deliver_finish
  ...
```

**分析方法**：
1. 找到 Count 最高的调用栈
2. 查看调用栈中的函数（如 `tcp_v4_rcv`）
3. 结合内核代码分析丢包原因
4. 上报开发团队进一步分析

---

## 3.4 状态监控工具

### 3.4.1 vhost_queue_correlation_simple.py

**功能**：监控 vhost-net 队列关联状态。

**适用场景**：
- vhost 队列问题排查
- VM 网络性能问题初步分析

**命令示例**：

```bash
sudo python vhost_queue_correlation_simple.py --vm-interface vnet0
```

### 3.4.2 tun_ring_monitor.py

**功能**：监控 TUN 设备环形缓冲区状态。

**适用场景**：
- TUN 设备问题排查
- 缓冲区溢出分析

**命令示例**：

```bash
sudo python tun_ring_monitor.py --interface tap0
```

### 3.4.3 ovs_upcall_latency_summary.py

**功能**：监控 OVS upcall 延迟分布。

**适用场景**：
- OVS 性能问题排查
- 首包延迟分析

**命令示例**：

```bash
sudo python ovs_upcall_latency_summary.py --interval 5
```
