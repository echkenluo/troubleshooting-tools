# 第2章 工具选择指南

本章是培训的核心章节，帮助你：

1. 理解工具的性能开销，避免影响生产环境
2. 根据问题类型选择正确的工具
3. 掌握完整的问题定界流程

---

## 2.1 性能开销模型（必读）

### 2.1.1 核心原则

工具的实际开销取决于 **通过过滤条件提交到 userspace 的事件数量**，而非原始流量大小。

- **Summary 类工具**：在内核态聚合（直方图），仅定期输出统计结果，无论流量多大开销都很低
- **Path Tracer 类工具**（stats 模式）：在 BPF 侧聚合统计，仅输出周期性 summary，开销被严格控制
- **Path Tracer 类工具**（verbose 模式）：逐包输出完整事件，开销取决于匹配流量
- **Details 类工具**：逐包输出完整元数据，开销取决于通过过滤的事件数量

**关键理解**：即使原始流量很大，只要过滤条件严格（如延迟阈值过滤、五元组过滤），实际提交到 userspace 的事件可以很少，开销就很低。反之，宽松的过滤加上大流量会导致高开销。

### 2.1.2 工具开销分级表

| 开销         | 工具                                       | 说明                         |
| ------------ | ------------------------------------------ | ---------------------------- |
| **低** | `icmp_path_tracer.py`                    | ICMP 流量通常 < 100 PPS      |
| **低** | `kernel_icmp_rtt.py`                     | 同上                         |
| **低** | `system_network_icmp_rtt.py`             | 同上                         |
| **低** | `*_latency_summary.py`                   | 内核态直方图聚合             |
| **低** | `eth_drop.py`                            | 仅跟踪丢包事件               |
| **低** | `kernel_drop_stack_stats_summary_all.py` | 按调用栈聚合                 |
| **低** | `tcp_path_tracer.py`（stats 模式）       | BPF 侧聚合，周期性输出       |
| **低** | `udp_path_tracer.py`（stats 模式）       | BPF 侧聚合，周期性输出       |
| **可变** | `tcp_path_tracer.py`（verbose 模式）     | 取决于匹配流量，需指定 IP 过滤 |
| **可变** | `udp_path_tracer.py`（verbose 模式）     | 取决于匹配流量，需指定 IP 过滤 |
| **可变** | `*_latency_details.py`                   | 取决于通过过滤的事件数       |
| **可变** | `vhost_queue_correlation_details.py`     | 取决于 VM 数量和流量         |

### 2.1.3 tcp/udp_path_tracer 双模式说明

`tcp_path_tracer.py` 和 `udp_path_tracer.py` 支持两种互斥模式：

| 模式 | 参数 | 输出内容 | 开销 |
|------|------|---------|------|
| **Stats 模式** | `--stats-mode` | 周期性 summary：延迟统计（avg/min/max/P50/P99）、路径首尾包匹配情况、内部丢包数 | 低（BPF 侧聚合） |
| **Verbose 模式** | `--verbose` | 逐包完整事件：每个包的四阶段时间戳和状态 | 可变（取决于匹配流量） |

**推荐**：优先使用 stats 模式进行定界，仅在需要逐包分析时切换到 verbose 模式。

```bash
# Stats 模式（低开销，适合长期运行）
sudo python tcp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0 \
    --stats-mode --stats-interval 10

# Verbose 模式（逐包输出）
sudo python tcp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0 \
    --verbose --src-port 5201
```

### 2.1.4 高开销场景安全指南

> **核心原则**：确保通过过滤提交到 userspace 的事件速率可控。

#### 降低事件速率的方法

| 方法 | 说明 | 示例 |
|------|------|------|
| 五元组过滤 | 指定 src-ip + dst-ip + protocol + port | 缩小匹配范围 |
| 延迟阈值过滤 | 使用 `--latency-ms` 仅输出高延迟事件 | 绝大部分正常包被过滤 |
| 端口过滤 | 指定 `--src-port` / `--dst-port` | 限定到特定连接 |

#### 使用 Details 工具前评估

```bash
# 估算过滤后的事件速率
timeout 10 tcpdump -i eth0 host 10.0.0.1 and host 10.0.0.2 -c 1000 2>&1 | tail -1
# "1000 packets captured" in 5 seconds → ~200 PPS

# 如果 PPS 较高，使用更严格的过滤：
# 1. 添加端口过滤
# 2. 使用延迟阈值过滤（--latency-ms）
# 3. 改用 Summary 工具
```

#### 过滤条件要求

| 过滤参数       | Details 工具   | Path Tracer 工具   |
| -------------- | -------------- | ------------------ |
| `--src-ip`   | **必须** | **必须**     |
| `--dst-ip`   | **必须** | **必须**     |
| `--protocol` | 建议           | 不适用（协议特定） |
| `--port`     | 建议（如支持） | 建议（如支持）     |

#### 正确 vs 错误用法示例

```bash
# 错误：无过滤条件，事件量不可控
sudo python vm_network_latency_details.py --vm-interface vnet0

# 错误：只有单向 IP，事件量可能仍然很大
sudo python vm_network_latency_details.py --vm-interface vnet0 --src-ip 10.0.0.1

# 正确：完整过滤条件
sudo python vm_network_latency_details.py --vm-interface vnet0 \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 --protocol tcp

# 正确：配合延迟阈值，仅关注高延迟包，可长期运行
sudo python system_network_latency_details.py \
    --phy-interface ens11 \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 --protocol tcp \
    --latency-ms 10
```

---

## 2.2 完整工具选择决策树

### 2.2.1 第一步：问题能否用 ICMP 复现？

```
问题能用 ping 复现吗？（延迟高、丢包、不通）
    │
    ├── 是 ──→ 【ICMP 快速定界】见 2.2.2
    │          优势：
    │          - 开销极低（ICMP 流量少）
    │          - 无需复杂过滤
    │          - 快速定界内部/外部问题
    │
    └── 否 ──→ 【协议专用工具】见 2.2.3
               适用：
               - TCP 连接问题（握手、重传）
               - UDP 特定端口问题
               - 业务流量问题
```

### 2.2.2 ICMP 快速定界路径（推荐）

```
ICMP 问题类型？
    │
    ├── 丢包（ping 丢包/不通）
    │   │
    │   └── icmp_path_tracer.py
    │       │
    │       ├── 系统网络
    │       │   sudo python icmp_path_tracer.py \
    │       │       --src-ip <本机IP> --dst-ip <对端IP> \
    │       │       --rx-iface <入接口> --tx-iface <出接口>
    │       │
    │       └── VM 网络（host 上部署）
    │           sudo python icmp_path_tracer.py \
    │               --src-ip <本机IP> --dst-ip <对端IP> \
    │               --rx-iface <物理口> --tx-iface <vnet口>
    │
    └── 延迟高（ping 延迟大）
        │
        ├── 系统网络（物理机、OVS internal port）
        │   │
        │   └── system_network_icmp_rtt.py
        │       sudo python system_network_icmp_rtt.py \
        │           --src-ip <本机IP> --dst-ip <对端IP> \
        │           --phy-interface <物理口> --direction tx
        │
        └── VM 网络（虚拟机）
            │
            ├── Host 上（始终可行）
            │   └── icmp_path_tracer.py
            │       sudo python icmp_path_tracer.py \
            │           --src-ip <VM_IP> --dst-ip <对端IP> \
            │           --rx-iface <物理口> --tx-iface <vnet口>
            │
            ├── VM 内可部署工具
            │   └── kernel_icmp_rtt.py
            │       sudo python kernel_icmp_rtt.py \
            │           --src-ip <VM_IP> --dst-ip <对端IP> \
            │           --interface <VM网卡> --direction tx
            │
            └── VM 内不可部署工具
                └── ping + tcpdump 推算（见第1章 1.2 场景3 方案C）
```

### 2.2.3 协议专用工具路径

```
网络类型 + 问题类型？
    │
    ├── 丢包问题
    │   │
    │   ├── TCP 丢包
    │   │   └── tcp_path_tracer.py（双端部署）
    │   │       # 推荐 stats 模式先定界
    │   │       sudo python tcp_path_tracer.py \
    │   │           --src-ip <源IP> --dst-ip <目的IP> \
    │   │           --rx-iface <入口> --tx-iface <出口> \
    │   │           --stats-mode --stats-interval 10
    │   │
    │   │       # 需要逐包分析时切换 verbose
    │   │       sudo python tcp_path_tracer.py \
    │   │           --src-ip <源IP> --dst-ip <目的IP> \
    │   │           --rx-iface <入口> --tx-iface <出口> \
    │   │           --verbose --src-port <端口>
    │   │
    │   │       双端部署：
    │   │       - 发送端宿主机运行
    │   │       - 接收端宿主机运行
    │   │       - 合并输出分析定界
    │   │
    │   ├── UDP 丢包
    │   │   └── udp_path_tracer.py（双端部署）
    │   │       # 推荐 stats 模式先定界
    │   │       sudo python udp_path_tracer.py \
    │   │           --src-ip <源IP> --dst-ip <目的IP> \
    │   │           --rx-iface <入口> --tx-iface <出口> \
    │   │           --stats-mode --stats-interval 10
    │   │
    │   │       注意：UDP 无连接，需在源/目两端都部署
    │   │
    │   └── 协议不明 / 需进一步分析
    │       │
    │       ├── 快速定位丢包点
    │       │   └── eth_drop.py
    │       │       sudo python eth_drop.py --interface <接口>
    │       │       输出：丢包位置、reason、内核调用栈
    │       │
    │       └── 聚合统计热点
    │           └── kernel_drop_stack_stats_summary_all.py
    │               sudo python kernel_drop_stack_stats_summary_all.py \
    │                   --interval 5
    │               输出：按调用栈聚合的丢包计数
    │               用途：识别热点丢包路径，配合内核代码分析
    │
    └── 延迟问题
        │
        ├── 系统网络
        │   │
        │   ├── 初步筛查 [低开销]
        │   │   └── system_network_latency_summary.py
        │   │       sudo python system_network_latency_summary.py \
        │   │           --phy-interface <物理口> \
        │   │           --src-ip <源IP> --dst-ip <目的IP> \
        │   │           --protocol tcp --direction rx --interval 5
        │   │
        │   │       输出：各阶段延迟直方图分布
        │   │       目标：识别异常时段、异常阶段
        │   │
        │   └── 精确定位 [需过滤]
        │       └── system_network_latency_details.py
        │           先从 summary 输出提取过滤条件！
        │           sudo python system_network_latency_details.py \
        │               --phy-interface <物理口> \
        │               --src-ip <源IP> --dst-ip <目的IP> \
        │               --protocol tcp --direction rx
        │
        └── VM 网络
            │
            ├── 初步筛查 [低开销]
            │   └── vm_network_latency_summary.py
            │       sudo python vm_network_latency_summary.py \
            │           --vm-interface <vnet口> --phy-interface <物理口> \
            │           --src-ip <源IP> --dst-ip <目的IP> \
            │           --protocol tcp --direction rx --interval 5
            │
            └── 精确定位 [需过滤]
                └── vm_network_latency_details.py
                    先从 summary 输出提取过滤条件！
                    sudo python vm_network_latency_details.py \
                        --vm-interface <vnet口> --phy-interface <物理口> \
                        --src-ip <源IP> --dst-ip <目的IP> \
                        --protocol tcp --direction rx
```

---

## 2.3 Summary → Details 分层策略

### 2.3.1 为什么要分层？

| 阶段     | 工具类型 | 开销 | 目标               |
| -------- | -------- | ---- | ------------------ |
| 第一阶段 | Summary  | 低   | 发现异常，缩小范围 |
| 第二阶段 | Details  | 可变 | 精确定位，找到根因 |
| 第三阶段 | Summary  | 低   | 验证修复，持续监控 |

### 2.3.2 标准流程

```
第一步：Summary 工具建立基线
    │
    │ 开销：低，可长时间运行
    │ 命令：*_latency_summary.py --interval 5
    │
    │ 目标输出：
    │ - 哪个阶段延迟异常？
    │ - 哪个时间段异常？
    │ - 哪些 IP 对异常？
    ↓
第二步：提取过滤条件
    │
    │ 从 Summary 输出中获取：
    │ - 异常源 IP：--src-ip
    │ - 异常目的 IP：--dst-ip
    │ - 异常协议：--protocol
    │ - 异常端口：--port（如有）
    │ - 延迟阈值：--latency-ms（如支持）
    ↓
第三步：Details 工具精确定位
    │
    │ 开销：取决于过滤后事件速率
    │ 命令：*_latency_details.py + 上述过滤条件
    │
    │ 目标输出：
    │ - 具体哪个包延迟高？
    │ - 延迟发生在哪个函数？
    │ - 调用栈是什么？
    ↓
第四步：修复后验证
    │
    │ 回到 Summary 工具持续监控
    │ 确认问题不再复现
```

### 2.3.3 实战示例

```bash
# 阶段1：Summary 发现问题
sudo python vm_network_latency_summary.py \
    --vm-interface vnet0 --phy-interface ens4f0 \
    --protocol tcp --direction rx --interval 5

# 输出发现：
# - OVS_RX 阶段 P99 延迟异常（> 1ms）
# - 主要来自 172.21.153.113 -> 172.21.153.114

# 阶段2：提取过滤条件
# src-ip: 172.21.153.113
# dst-ip: 172.21.153.114
# protocol: tcp

# 阶段3：Details 精确定位
sudo python vm_network_latency_details.py \
    --vm-interface vnet0 --phy-interface ens4f0 \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --protocol tcp --direction rx

# 输出：逐包延迟详情，定位到具体瓶颈函数

# 阶段4：修复后验证
sudo python vm_network_latency_summary.py \
    --vm-interface vnet0 --phy-interface ens4f0 \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --protocol tcp --direction rx --interval 10
```

---

## 2.4 工具速查表

### 2.4.1 按问题类型

| 问题                  | 定界工具（阶段一）                               | 详情工具（阶段二）                             |
| --------------------- | ------------------------------------------------ | ---------------------------------------------- |
| ICMP 丢包             | `icmp_path_tracer.py`                          | `eth_drop.py`、`kernel_drop_*`               |
| ICMP 延迟（系统网络） | `system_network_icmp_rtt.py`                   | `system_network_latency_summary/details.py`  |
| ICMP 延迟（VM 网络）  | `icmp_path_tracer.py` + `kernel_icmp_rtt.py` | `vm_network_latency_summary/details.py`      |
| TCP 丢包              | `tcp_path_tracer.py`（stats 模式）             | `eth_drop.py`                                |
| UDP 丢包              | `udp_path_tracer.py`（stats 模式）             | `eth_drop.py`                                |
| 协议不明丢包          | `eth_drop.py`                                  | `kernel_drop_stack_stats_summary_all.py`     |
| 系统网络延迟          | `system_network_latency_summary.py`            | `system_network_latency_details.py`          |
| VM 网络延迟           | `vm_network_latency_summary.py`                | `vm_network_latency_details.py`              |

### 2.4.2 按网络类型

| 网络类型 | 丢包定界                      | 延迟定界                                         |
| -------- | ----------------------------- | ------------------------------------------------ |
| 系统网络 | `icmp_path_tracer.py`       | `system_network_icmp_rtt.py`                   |
| VM 网络  | `icmp_path_tracer.py`       | `icmp_path_tracer.py` + `kernel_icmp_rtt.py` |
| 跨节点   | `*_path_tracer.py` 多点部署 | `*_latency_summary.py`                         |

### 2.4.3 开销速查

| 开销等级       | 工具                             | 说明                         |
| -------------- | -------------------------------- | ---------------------------- |
| 低             | `*_path_tracer.py`（ICMP）     | ICMP 流量少                  |
| 低             | `*_icmp_rtt.py`                | ICMP 流量少                  |
| 低             | `*_summary.py`                 | 内核态聚合                   |
| 低             | `eth_drop.py`                  | 仅跟踪丢包事件               |
| 低             | `tcp/udp_path_tracer`（stats） | BPF 侧聚合                  |
| 可变           | `tcp/udp_path_tracer`（verbose）| 取决于匹配流量               |
| **可变** | `*_details.py`                 | **取决于过滤后事件速率** |
