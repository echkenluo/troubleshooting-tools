# 第2章 工具选择指南

本章是培训的核心章节，帮助你：

1. 理解工具的性能开销，避免影响生产环境
2. 根据问题类型选择正确的工具
3. 掌握完整的问题定界流程

---

## 2.1 性能开销模型（必读）

### 2.1.1 开销等级定义

| 等级         | 特征                  | 适用场景                     | 运行时长      |
| ------------ | --------------------- | ---------------------------- | ------------- |
| **低** | 内核态聚合，定期输出  | 生产环境，长期监控           | 不限          |
| **中** | Per-event 轻量跟踪    | 问题复现期间                 | 建议 < 30分钟 |
| **高** | Per-packet 完整元数据 | 精确定位，**必须过滤** | 建议 < 5分钟  |

### 2.1.2 工具开销分级表

| 开销         | 工具                                       | 说明                         |
| ------------ | ------------------------------------------ | ---------------------------- |
| **低** | `icmp_path_tracer.py`                    | ICMP 流量通常 < 100 PPS      |
| **低** | `kernel_icmp_rtt.py`                     | 同上                         |
| **低** | `system_network_icmp_rtt.py`             | 同上                         |
| **低** | `*_latency_summary.py`                   | 内核态直方图聚合             |
| **低** | `eth_drop.py`                            | 仅跟踪丢包事件               |
| **低** | `kernel_drop_stack_stats_summary_all.py` | 按调用栈聚合                 |
| **中** | `tcp_path_tracer.py`                     | 需指定 IP 过滤               |
| **中** | `udp_path_tracer.py`                     | 需指定 IP 过滤               |
| **高** | `*_latency_details.py`                   | **必须**指定五元组过滤 |
| **高** | `vhost_queue_correlation_details.py`     | **必须**限制 VM 范围   |

### 2.1.3 高开销工具使用安全指南

> **警告**：Details 类工具在高流量环境下可能影响系统性能，请严格遵循以下指南。

#### 使用前必须评估流量

```bash
# 步骤1：估算目标流量 PPS
timeout 10 tcpdump -i eth0 host 10.0.0.1 and host 10.0.0.2 -c 1000 2>&1 | tail -1
# 输出示例: "1000 packets captured" in 5 seconds → 200 PPS（安全）
# 输出示例: "1000 packets captured" in 0.1 seconds → 10000 PPS（需谨慎）
```

#### 过滤后流量阈值

| 过滤后 PPS | 风险等级       | 建议                                  |
| ---------- | -------------- | ------------------------------------- |
| < 1K       | 安全           | 可运行 5-10 分钟                      |
| 1K - 10K   | 中等           | 限制在 2-3 分钟内                     |
| 10K - 50K  | 较高           | 仅在必要时运行，< 1分钟               |
| > 50K      | **危险** | 不建议使用 Details 工具，改用 Summary |

#### 过滤条件要求

| 过滤参数       | Details 工具   | Path Tracer 工具   |
| -------------- | -------------- | ------------------ |
| `--src-ip`   | **必须** | **必须**     |
| `--dst-ip`   | **必须** | **必须**     |
| `--protocol` | 建议           | 不适用（协议特定） |
| `--port`     | 建议（如支持） | 建议（如支持）     |

#### 正确 vs 错误用法示例

```bash
# 错误：无过滤条件，可能导致系统负载过高
sudo python vm_network_latency_details.py --vm-interface vnet0

# 错误：只有单向 IP，流量可能仍然很大
sudo python vm_network_latency_details.py --vm-interface vnet0 --src-ip 10.0.0.1

# 正确：完整五元组过滤
sudo python vm_network_latency_details.py --vm-interface vnet0 \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 --protocol tcp

# 正确：指定端口进一步缩小范围
sudo python vm_network_latency_details.py --vm-interface vnet0 \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 --protocol tcp --port 3260
```

---

## 2.2 完整工具选择决策树

### 2.2.1 第一步：问题能否用 ICMP 复现？

```
问题能用 ping 复现吗？（延迟高、丢包、不通）
    │
    ├── 是 ──→ 【ICMP 快速定界】见 2.2.2
    │          优势：
    │          - 开销极低（ICMP 流量少）
    │          - 无需复杂过滤
    │          - 快速定界内部/外部问题
    │
    └── 否 ──→ 【协议专用工具】见 2.2.3
               适用：
               - TCP 连接问题（握手、重传）
               - UDP 特定端口问题
               - 业务流量问题
```

### 2.2.2 ICMP 快速定界路径（推荐）

```
ICMP 问题类型？
    │
    ├── 丢包（ping 丢包/不通）
    │   │
    │   └── icmp_path_tracer.py
    │       │
    │       ├── 系统网络
    │       │   sudo python icmp_path_tracer.py \
    │       │       --src-ip <本机IP> --dst-ip <对端IP> \
    │       │       --rx-iface <入接口> --tx-iface <出接口>
    │       │
    │       └── VM 网络
    │           sudo python icmp_path_tracer.py \
    │               --src-ip <本机IP> --dst-ip <对端IP> \
    │               --rx-iface <物理口> --tx-iface <vnet口>
    │
    └── 延迟高（ping 延迟大）
        │
        ├── 系统网络（物理机、OVS internal port）
        │   │
        │   └── system_network_icmp_rtt.py
        │       sudo python system_network_icmp_rtt.py \
        │           --src-ip <本机IP> --dst-ip <对端IP> \
        │           --phy-interface <物理口> --direction tx
        │
        └── VM 网络（虚拟机）
            │
            └── icmp_path_tracer.py + kernel_icmp_rtt.py 组合
                │
                ├── 步骤1：path_tracer 定界内部/外部
                │   sudo python icmp_path_tracer.py \
                │       --src-ip <VM_IP> --dst-ip <对端IP> \
                │       --rx-iface <物理口> --tx-iface <vnet口>
                │
                └── 步骤2：kernel_icmp_rtt 测量各阶段延迟
                    sudo python kernel_icmp_rtt.py \
                        --src-ip <VM_IP> --dst-ip <对端IP> \
                        --interface <物理口> --direction tx
```

### 2.2.3 协议专用工具路径

```
网络类型 + 问题类型？
    │
    ├── 丢包问题
    │   │
    │   ├── TCP 丢包
    │   │   └── tcp_path_tracer.py（多点部署）
    │   │       sudo python tcp_path_tracer.py \
    │   │           --src-ip <源IP> --dst-ip <目的IP> \
    │   │           --rx-iface <入口> --tx-iface <出口> \
    │   │           --src-port <端口>        # 建议指定
    │   │
    │   │       多节点部署：
    │   │       - 发送端宿主机运行
    │   │       - 接收端宿主机运行
    │   │       - 合并输出分析定界
    │   │
    │   ├── UDP 丢包
    │   │   └── udp_path_tracer.py（多点部署）
    │   │       sudo python udp_path_tracer.py \
    │   │           --src-ip <源IP> --dst-ip <目的IP> \
    │   │           --rx-iface <入口> --tx-iface <出口> \
    │   │           --dst-port <端口>        # 建议指定
    │   │
    │   │       注意：UDP 无连接，需在源/目两端都部署
    │   │
    │   └── 协议不明 / 需进一步分析
    │       │
    │       ├── 快速定位丢包点
    │       │   └── eth_drop.py
    │       │       sudo python eth_drop.py --interface <接口>
    │       │       输出：丢包位置、reason、内核调用栈
    │       │
    │       └── 聚合统计热点
    │           └── kernel_drop_stack_stats_summary_all.py
    │               sudo python kernel_drop_stack_stats_summary_all.py \
    │                   --interval 5
    │               输出：按调用栈聚合的丢包计数
    │               用途：识别热点丢包路径，配合内核代码分析
    │
    └── 延迟问题
        │
        ├── 系统网络
        │   │
        │   ├── 初步筛查 [低开销]
        │   │   └── system_network_latency_summary.py
        │   │       sudo python system_network_latency_summary.py \
        │   │           --phy-interface <物理口> \
        │   │           --src-ip <源IP> --dst-ip <目的IP> \
        │   │           --protocol tcp --direction rx --interval 5
        │   │
        │   │       输出：各阶段延迟直方图分布
        │   │       目标：识别异常时段、异常阶段
        │   │
        │   └── 精确定位 [高开销⚠️]
        │       └── system_network_latency_details.py
        │           先从 summary 输出提取过滤条件！
        │           sudo python system_network_latency_details.py \
        │               --phy-interface <物理口> \
        │               --src-ip <源IP> --dst-ip <目的IP> \
        │               --protocol tcp --direction rx
        │
        └── VM 网络
            │
            ├── 初步筛查 [低开销]
            │   └── vm_network_latency_summary.py
            │       sudo python vm_network_latency_summary.py \
            │           --vm-interface <vnet口> --phy-interface <物理口> \
            │           --src-ip <源IP> --dst-ip <目的IP> \
            │           --protocol tcp --direction rx --interval 5
            │
            └── 精确定位 [高开销⚠️]
                └── vm_network_latency_details.py
                    先从 summary 输出提取过滤条件！
                    sudo python vm_network_latency_details.py \
                        --vm-interface <vnet口> --phy-interface <物理口> \
                        --src-ip <源IP> --dst-ip <目的IP> \
                        --protocol tcp --direction rx
```

---

## 2.3 Summary → Details 分层策略

### 2.3.1 为什么要分层？

| 阶段     | 工具类型 | 开销 | 目标               |
| -------- | -------- | ---- | ------------------ |
| 第一阶段 | Summary  | 低   | 发现异常，缩小范围 |
| 第二阶段 | Details  | 高   | 精确定位，找到根因 |
| 第三阶段 | Summary  | 低   | 验证修复，持续监控 |

### 2.3.2 标准流程

```
第一步：Summary 工具建立基线
    │
    │ 开销：低，可长时间运行（小时级）
    │ 命令：*_latency_summary.py --interval 5
    │
    │ 目标输出：
    │ - 哪个阶段延迟异常？
    │ - 哪个时间段异常？
    │ - 哪些 IP 对异常？
    ↓
第二步：提取过滤条件
    │
    │ 从 Summary 输出中获取：
    │ - 异常源 IP：--src-ip
    │ - 异常目的 IP：--dst-ip
    │ - 异常协议：--protocol
    │ - 异常端口：--port（如有）
    ↓
第三步：Details 工具精确定位
    │
    │ 开销：高，短时间运行（分钟级）
    │ 命令：*_latency_details.py + 上述过滤条件
    │
    │ 目标输出：
    │ - 具体哪个包延迟高？
    │ - 延迟发生在哪个函数？
    │ - 调用栈是什么？
    ↓
第四步：修复后验证
    │
    │ 回到 Summary 工具持续监控
    │ 确认问题不再复现
```

### 2.3.3 实战示例

```bash
# 阶段1：Summary 发现问题
sudo python vm_network_latency_summary.py \
    --vm-interface vnet0 --phy-interface ens4f0 \
    --protocol tcp --direction rx --interval 5

# 输出发现：
# - OVS_RX 阶段 P99 延迟异常（> 1ms）
# - 主要来自 172.21.153.113 → 172.21.153.114

# 阶段2：提取过滤条件
# src-ip: 172.21.153.113
# dst-ip: 172.21.153.114
# protocol: tcp

# 阶段3：Details 精确定位
sudo python vm_network_latency_details.py \
    --vm-interface vnet0 --phy-interface ens4f0 \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --protocol tcp --direction rx

# 输出：逐包延迟详情，定位到具体瓶颈函数

# 阶段4：修复后验证
sudo python vm_network_latency_summary.py \
    --vm-interface vnet0 --phy-interface ens4f0 \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --protocol tcp --direction rx --interval 10
```

---

## 2.4 工具速查表

### 2.4.1 按问题类型

| 问题                  | 首选工具（低开销）                               | 深入工具                                   |
| --------------------- | ------------------------------------------------ | ------------------------------------------ |
| ICMP 丢包             | `icmp_path_tracer.py`                          | -                                          |
| ICMP 延迟（系统网络） | `system_network_icmp_rtt.py`                   | -                                          |
| ICMP 延迟（VM 网络）  | `icmp_path_tracer.py` + `kernel_icmp_rtt.py` | -                                          |
| TCP 丢包              | `tcp_path_tracer.py`                           | `eth_drop.py`                            |
| UDP 丢包              | `udp_path_tracer.py`                           | `eth_drop.py`                            |
| 协议不明丢包          | `eth_drop.py`                                  | `kernel_drop_stack_stats_summary_all.py` |
| 系统网络延迟          | `system_network_latency_summary.py`            | `*_details.py` ⚠️                      |
| VM 网络延迟           | `vm_network_latency_summary.py`                | `*_details.py` ⚠️                      |

### 2.4.2 按网络类型

| 网络类型 | 丢包定界                      | 延迟定界                                         |
| -------- | ----------------------------- | ------------------------------------------------ |
| 系统网络 | `icmp_path_tracer.py`       | `system_network_icmp_rtt.py`                   |
| VM 网络  | `icmp_path_tracer.py`       | `icmp_path_tracer.py` + `kernel_icmp_rtt.py` |
| 跨节点   | `*_path_tracer.py` 多点部署 | `*_latency_summary.py`                         |

### 2.4.3 开销速查

| 开销等级     | 工具                         | 使用限制           |
| ------------ | ---------------------------- | ------------------ |
| 低           | `*_path_tracer.py`（ICMP） | 无                 |
| 低           | `*_icmp_rtt.py`            | 无                 |
| 低           | `*_summary.py`             | 无                 |
| 低           | `eth_drop.py`              | 无                 |
| 中           | `tcp_path_tracer.py`       | 建议过滤           |
| 中           | `udp_path_tracer.py`       | 建议过滤           |
| **高** | `*_details.py`             | **必须过滤** |
