# 第1章 快速入门

本章帮助你在 5 分钟内掌握最常用的网络问题定界方法。

## 1.1 三个最常见场景

### 场景1：网络丢包定界（ICMP）

**问题**：ping 对端丢包或不通，需要确定是本机问题还是网络/对端问题。

```bash
sudo python icmp_path_tracer.py \
    --src-ip 10.0.0.1 --dst-ip 10.0.0.2 \
    --rx-iface ens4f0 --tx-iface vnet0
```

**输出解读**：
```
[14:32:15.123] ICMP id=1234 seq=1
  [0] REQ_RX  ens4f0   ts=1234567890
  [1] REQ_TX  vnet0    ts=1234567920  (+30us)
  [2] REP_RX  vnet0    ts=1234568100  (+180us)
  [3] REP_TX  ens4f0   ts=1234568130  (+30us)
  STATUS: COMPLETE

[14:32:16.125] ICMP id=1234 seq=2
  [0] REQ_RX  ens4f0   ts=1234667890
  [1] REQ_TX  vnet0    ts=1234667920  (+30us)
  STATUS: EXTERNAL_DROP (missing REP_RX after 1000ms)
```

| 状态 | 含义 | 下一步 |
|------|------|--------|
| `COMPLETE` | 包正常通过 | 无问题 |
| `INTERNAL_DROP (REQ)` | 请求包在本机内部丢失 | 检查本机转发配置、OVS 规则 |
| `EXTERNAL_DROP` | 包已发出但无回复 | 检查网络、对端 |
| `INTERNAL_DROP (REP)` | 回复包在本机内部丢失 | 检查本机回复路径 |

---

### 场景2：系统网络延迟定界

**问题**：系统网络（物理机、OVS internal port）延迟高，需要定位延迟在哪个阶段。

```bash
sudo python system_network_icmp_rtt.py \
    --src-ip 10.132.114.11 --dst-ip 10.132.114.12 \
    --phy-interface ens11 --direction tx
```

**输出解读**：
```
=== System Network ICMP RTT Tracer ===
Direction: TX (local ping remote)
Filter: 10.132.114.11 -> 10.132.114.12

[14:35:22.456] seq=1 TOTAL_RTT=245us
  TX: ip_local_out -> netif_receive_skb: 45us
      netif_receive_skb -> ip_rcv: 12us
      ip_rcv -> net_dev_xmit: 28us
  RX: netif_receive_skb -> icmp_rcv: 35us
  WIRE_TIME: 125us

[14:35:23.458] seq=2 TOTAL_RTT=1523us  <<<< ABNORMAL
  TX: ip_local_out -> netif_receive_skb: 42us
      netif_receive_skb -> ip_rcv: 1105us  <<<< BOTTLENECK
      ip_rcv -> net_dev_xmit: 31us
  ...
```

**关注点**：
- `TOTAL_RTT`：总往返时间
- 各阶段时间：定位瓶颈在哪一段
- `WIRE_TIME`：网络传输时间（排除本机处理）

---

### 场景3：VM 网络延迟定界

**问题**：虚拟机网络延迟高，需要定位是虚拟化层还是物理网络问题。

**步骤1**：用 icmp_path_tracer 确认路径

```bash
sudo python icmp_path_tracer.py \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --rx-iface ens4f0 --tx-iface vnet0
```

**步骤2**：用 kernel_icmp_rtt 测量内核各阶段

```bash
sudo python kernel_icmp_rtt.py \
    --src-ip 172.21.153.113 --dst-ip 172.21.153.114 \
    --interface ens4f0 --direction tx
```

**输出解读**：
```
[14:40:11.789] seq=1 RTT=312us
  ip_local_out -> net_dev_xmit: 85us     # 本机发送处理
  netif_receive_skb -> icmp_rcv: 47us    # 本机接收处理
  ESTIMATED_WIRE: 180us                   # 网络+对端

如果 ip_local_out -> net_dev_xmit 很大：虚拟化层/OVS 瓶颈
如果 ESTIMATED_WIRE 很大：物理网络/对端问题
```

---

## 1.2 快速选择指南

```
我遇到了什么问题？
    │
    ├── 丢包/不通 → icmp_path_tracer.py
    │
    ├── 延迟高
    │   ├── 系统网络 → system_network_icmp_rtt.py
    │   └── VM 网络 → icmp_path_tracer.py + kernel_icmp_rtt.py
    │
    └── 不确定 → 先用 icmp_path_tracer.py 看整体情况
```

---

## 1.3 下一步

- 问题无法用 ICMP 复现？→ 第2章 工具选择指南
- 需要深入了解某个工具？→ 第3章 核心工具详解
- 看不懂输出？→ 第5章 常见问题与输出解读
