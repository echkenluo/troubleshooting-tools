# 附录 命令速查表

本速查表供日常使用快速参考，可打印保存。

---

## A. 定界命令（阶段一）

### A.1 丢包定界

```bash
# ICMP 丢包定界（系统网络 / VM 网络通用）
sudo python icmp_path_tracer.py \
    --src-ip <本机IP> --dst-ip <对端IP> \
    --rx-iface <入接口> --tx-iface <出接口>

# TCP 丢包定界（stats 模式，低开销）
sudo python tcp_path_tracer.py \
    --src-ip <源IP> --dst-ip <目的IP> \
    --rx-iface <入口> --tx-iface <出口> \
    --stats-mode --stats-interval 10

# TCP 丢包定界（verbose 模式，逐包）
sudo python tcp_path_tracer.py \
    --src-ip <源IP> --dst-ip <目的IP> \
    --rx-iface <入口> --tx-iface <出口> \
    --verbose --src-port <端口>

# UDP 丢包定界（stats 模式，低开销）
sudo python udp_path_tracer.py \
    --src-ip <源IP> --dst-ip <目的IP> \
    --rx-iface <入口> --tx-iface <出口> \
    --stats-mode --stats-interval 10
```

### A.2 延迟定界

```bash
# 系统网络延迟定界
sudo python system_network_icmp_rtt.py \
    --src-ip <本机IP> --dst-ip <对端IP> \
    --phy-interface <物理口> --direction tx

# VM 网络延迟定界 - Host 上（始终可行）
sudo python icmp_path_tracer.py \
    --src-ip <VM_IP> --dst-ip <对端IP> \
    --rx-iface <物理口> --tx-iface <vnet口>

# VM 网络延迟定界 - VM 内（需部署工具）
sudo python kernel_icmp_rtt.py \
    --src-ip <VM_IP> --dst-ip <对端IP> \
    --interface <VM网卡> --direction tx
```

---

## B. 详情分析命令（阶段二）

### B.1 丢包详情

```bash
# 快速检测丢包
sudo python eth_drop.py --src-ip <源IP> --dst-ip <目的IP>

# 丢包栈聚合统计
sudo python kernel_drop_stack_stats_summary_all.py --interval 5
```

### B.2 延迟详情

```bash
# 系统网络 Summary（低开销）
sudo python system_network_latency_summary.py \
    --phy-interface <物理口> \
    --src-ip <源IP> --dst-ip <目的IP> \
    --protocol tcp --direction rx --interval 5

# 系统网络 Details（需过滤）
sudo python system_network_latency_details.py \
    --phy-interface <物理口> \
    --src-ip <源IP> --dst-ip <目的IP> \
    --protocol tcp --direction rx

# VM 网络 Summary（低开销）
sudo python vm_network_latency_summary.py \
    --vm-interface <vnet口> --phy-interface <物理口> \
    --src-ip <源IP> --dst-ip <目的IP> \
    --protocol tcp --direction rx --interval 5

# VM 网络 Details（需过滤）
sudo python vm_network_latency_details.py \
    --vm-interface <vnet口> --phy-interface <物理口> \
    --src-ip <源IP> --dst-ip <目的IP> \
    --protocol tcp --direction rx
```

---

## C. OVS / 虚拟化诊断命令

```bash
# OVS upcall 延迟
sudo python ovs_upcall_latency_summary.py --interval 5

# OVS 内核模块丢包
sudo python ovs-kernel-module-drop-monitor.py

# TUN 环形缓冲区监控
sudo python tun_ring_monitor.py --interface tap0

# vhost 队列关联
sudo python vhost_queue_correlation_simple.py --vm-interface vnet0

# KVM 中断统计
sudo python kvm_irqfd_stats_summary.py
```

---

## D. 开销速查

| 开销等级       | 工具                               | 说明                           |
| -------------- | ---------------------------------- | ------------------------------ |
| 低             | `*_path_tracer.py`（ICMP）       | ICMP 流量少                    |
| 低             | `*_icmp_rtt.py`                  | ICMP 流量少                    |
| 低             | `*_summary.py`                   | 内核态聚合                     |
| 低             | `eth_drop.py`                    | 仅跟踪丢包事件                 |
| 低             | `tcp/udp_path_tracer`（stats）   | BPF 侧聚合                     |
| 可变           | `tcp/udp_path_tracer`（verbose） | 取决于匹配流量                 |
| **可变** | `*_details.py`                   | **取决于过滤后事件速率** |

---

## E. 参数速查

### 通用参数

| 参数             | 说明           | 示例                                   |
| ---------------- | -------------- | -------------------------------------- |
| `--src-ip`     | 源 IP          | `10.0.0.1`                           |
| `--dst-ip`     | 目的 IP        | `10.0.0.2`                           |
| `--interface`  | 接口名         | `ens4f0`                             |
| `--protocol`   | 协议           | `tcp` / `udp` / `icmp` / `all` |
| `--direction`  | 方向           | `tx` / `rx` / `both`             |
| `--interval`   | 输出间隔（秒） | `5`                                  |
| `--latency-ms` | 延迟阈值过滤   | `10`                                 |

### Path Tracer 参数

| 参数                 | 说明                  | 示例                            |
| -------------------- | --------------------- | ------------------------------- |
| `--rx-iface`       | 入向接口              | `ens4f0` 或 `ens4f0,ens4f1` |
| `--tx-iface`       | 出向接口              | `vnet0`                       |
| `--timeout-ms`     | 超时（毫秒）          | `1000`                        |
| `--src-port`       | 源端口                | `5201`                        |
| `--dst-port`       | 目的端口              | `3260`                        |
| `--stats-mode`     | Stats 模式（TCP/UDP） | -                               |
| `--stats-interval` | Stats 输出间隔        | `10`                          |
| `--verbose`        | Verbose 模式          | -                               |

### 延迟工具参数

| 参数                | 说明         | 示例      |
| ------------------- | ------------ | --------- |
| `--phy-interface` | 物理接口     | `ens11` |
| `--vm-interface`  | VM 接口      | `vnet0` |
| `--latency-ms`    | 延迟阈值过滤 | `10`    |

---

## F. 问题排查流程图

```
┌──────────────────────────────────────────────────────┐
│                   网络问题排查                         │
└──────────────────────────────────────────────────────┘
                         │
                    ┌────┴────┐
                    │ 阶段一   │
                    │  定界    │
                    └────┬────┘
                         │
              ┌─── 能用 ping 复现？ ───┐
              │                        │
              是                       否
              │                        │
              ▼                        ▼
    ┌─────────────────┐     ┌─────────────────┐
    │ ICMP 定界        │     │ 协议专用定界     │
    │                 │     │                 │
    │ 丢包:           │     │ TCP: tcp_path   │
    │  icmp_path      │     │   (stats 模式)  │
    │                 │     │ UDP: udp_path   │
    │ 延迟(系统):     │     │   (stats 模式)  │
    │  system_icmp_rtt│     │ 不明: eth_drop  │
    │                 │     │                 │
    │ 延迟(VM):       │     └─────────────────┘
    │  icmp_path(host)│
    │  kernel_icmp_rtt│
    │    (VM内)       │
    └────────┬────────┘
             │
        ┌────┴────┐
        │ 阶段二   │
        │  详情    │
        └────┬────┘
             │
    ┌────────┴────────┐
    │                 │
    ▼                 ▼
  丢包详情          延迟详情
  eth_drop         *_summary (先)
  kernel_drop_*    *_details (后)
```

---

## G. 状态码速查

### Path Tracer 状态

| 状态                  | 含义           | 下一步              |
| --------------------- | -------------- | ------------------- |
| `COMPLETE`          | 正常           | 无                  |
| `EXTERNAL_DROP`     | 网络/对端问题  | 查网络、对端        |
| `INTERNAL_DROP_REQ` | 本机请求未转发 | 查路由、OVS、防火墙 |
| `INTERNAL_DROP_REP` | 本机回复未转发 | 查回复路径          |

### 丢包 Reason

| Reason             | 含义       |
| ------------------ | ---------- |
| `NOT_SPECIFIED`  | 需看调用栈 |
| `NO_SOCKET`      | 端口未监听 |
| `NETFILTER_DROP` | 防火墙丢弃 |
| `TCP_RESET`      | 连接被重置 |

---

## H. 延迟参考值

| 场景       | 正常范围  | 告警    |
| ---------- | --------- | ------- |
| 同机 VM 间 | 50-200us  | > 500us |
| 同机架     | 100-500us | > 1ms   |
| 跨机架     | 200us-1ms | > 2ms   |
| OVS upcall | 10-100us  | > 500us |

---

## I. 信息收集清单

上报问题时需收集：

```bash
# 系统信息
uname -a
cat /etc/os-release

# 工具输出（保存到文件）
sudo python <工具> <参数> 2>&1 | tee output.log

# 网络信息
ip addr show
ip route show
ovs-vsctl show  # 如有 OVS
```

---
