# 附录 命令速查表

本速查表供日常使用快速参考，可打印保存。

---

## A. 快速定界命令

### A.1 丢包定界（ICMP）

```bash
# 系统网络丢包定界
sudo python icmp_path_tracer.py \
    --src-ip <本机IP> --dst-ip <对端IP> \
    --rx-iface <入接口> --tx-iface <出接口>

# VM 网络丢包定界
sudo python icmp_path_tracer.py \
    --src-ip <本机IP> --dst-ip <对端IP> \
    --rx-iface <物理口> --tx-iface <vnet口>
```

### A.2 延迟定界（ICMP）

```bash
# 系统网络延迟定界
sudo python system_network_icmp_rtt.py \
    --src-ip <本机IP> --dst-ip <对端IP> \
    --phy-interface <物理口> --direction tx

# VM 网络延迟定界（两步）
# 步骤1
sudo python icmp_path_tracer.py \
    --src-ip <VM_IP> --dst-ip <对端IP> \
    --rx-iface <物理口> --tx-iface <vnet口>

# 步骤2
sudo python kernel_icmp_rtt.py \
    --src-ip <VM_IP> --dst-ip <对端IP> \
    --interface <物理口> --direction tx
```

---

## B. 协议专用命令

### B.1 TCP 丢包

```bash
sudo python tcp_path_tracer.py \
    --src-ip <源IP> --dst-ip <目的IP> \
    --rx-iface <入口> --tx-iface <出口> \
    --src-port <端口>
```

### B.2 UDP 丢包

```bash
sudo python udp_path_tracer.py \
    --src-ip <源IP> --dst-ip <目的IP> \
    --rx-iface <入口> --tx-iface <出口> \
    --dst-port <端口>
```

### B.3 通用丢包检测

```bash
# 快速检测
sudo python eth_drop.py --interface <接口>

# 聚合统计
sudo python kernel_drop_stack_stats_summary_all.py --interval 5
```

---

## C. 延迟监控命令

### C.1 系统网络延迟

```bash
# Summary（低开销，长期监控）
sudo python system_network_latency_summary.py \
    --phy-interface <物理口> \
    --src-ip <源IP> --dst-ip <目的IP> \
    --protocol tcp --direction rx --interval 5

# Details（高开销，精确定位）
sudo python system_network_latency_details.py \
    --phy-interface <物理口> \
    --src-ip <源IP> --dst-ip <目的IP> \
    --protocol tcp --direction rx
```

### C.2 VM 网络延迟

```bash
# Summary（低开销，长期监控）
sudo python vm_network_latency_summary.py \
    --vm-interface <vnet口> --phy-interface <物理口> \
    --src-ip <源IP> --dst-ip <目的IP> \
    --protocol tcp --direction rx --interval 5

# Details（高开销，精确定位）
sudo python vm_network_latency_details.py \
    --vm-interface <vnet口> --phy-interface <物理口> \
    --src-ip <源IP> --dst-ip <目的IP> \
    --protocol tcp --direction rx
```

---

## D. 开销速查

| 工具类型 | 开销 | 使用限制 |
|---------|------|---------|
| `*_path_tracer.py` | 低 | 无 |
| `*_icmp_rtt.py` | 低 | 无 |
| `*_summary.py` | 低 | 无 |
| `eth_drop.py` | 低 | 无 |
| `*_details.py` | **高** | **必须指定 src-ip + dst-ip** |

---

## E. 参数速查

### 通用参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--src-ip` | 源 IP | `10.0.0.1` |
| `--dst-ip` | 目的 IP | `10.0.0.2` |
| `--interface` | 接口名 | `ens4f0` |
| `--protocol` | 协议 | `tcp` / `udp` / `icmp` / `all` |
| `--direction` | 方向 | `tx` / `rx` / `both` |
| `--interval` | 输出间隔（秒） | `5` |

### Path Tracer 参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--rx-iface` | 入向接口 | `ens4f0` 或 `ens4f0,ens4f1` |
| `--tx-iface` | 出向接口 | `vnet0` |
| `--timeout-ms` | 超时（毫秒） | `1000` |
| `--src-port` | 源端口 | `5201` |
| `--dst-port` | 目的端口 | `3260` |

### 延迟工具参数

| 参数 | 说明 | 示例 |
|------|------|------|
| `--phy-interface` | 物理接口 | `ens11` |
| `--vm-interface` | VM 接口 | `vnet0` |
| `--latency-ms` | 延迟阈值过滤 | `10` |

---

## F. 问题定界流程图

```
┌──────────────────────────────────────────────────────────┐
│                    网络问题定界                           │
└──────────────────────────────────────────────────────────┘
                           │
                           ▼
              ┌─── 能用 ping 复现？ ───┐
              │                        │
              是                       否
              │                        │
              ▼                        ▼
    ┌─────────────────┐     ┌─────────────────┐
    │ ICMP 快速定界    │     │ 协议专用工具     │
    │                 │     │                 │
    │ 丢包:           │     │ TCP: tcp_path   │
    │  icmp_path      │     │ UDP: udp_path   │
    │                 │     │ 不明: eth_drop  │
    │ 延迟(系统):     │     │                 │
    │  system_icmp_rtt│     │ 延迟:           │
    │                 │     │  *_summary (先) │
    │ 延迟(VM):       │     │  *_details (后) │
    │  icmp_path +    │     │                 │
    │  kernel_icmp_rtt│     │                 │
    └─────────────────┘     └─────────────────┘
```

---

## G. 状态码速查

### Path Tracer 状态

| 状态 | 含义 | 下一步 |
|------|------|--------|
| `COMPLETE` | 正常 | 无 |
| `EXTERNAL_DROP` | 网络/对端问题 | 查网络、对端 |
| `INTERNAL_DROP_REQ` | 本机请求未转发 | 查路由、OVS、防火墙 |
| `INTERNAL_DROP_REP` | 本机回复未转发 | 查回复路径 |

### 丢包 Reason

| Reason | 含义 |
|--------|------|
| `NOT_SPECIFIED` | 需看调用栈 |
| `NO_SOCKET` | 端口未监听 |
| `NETFILTER_DROP` | 防火墙丢弃 |
| `TCP_RESET` | 连接被重置 |

---

## H. 延迟参考值

| 场景 | 正常范围 | 告警 |
|------|---------|------|
| 同机 VM 间 | 50-200us | > 500us |
| 同机架 | 100-500us | > 1ms |
| 跨机架 | 200us-1ms | > 2ms |
| OVS upcall | 10-100us | > 500us |

---

## I. 信息收集清单

上报问题时需收集：

```bash
# 系统信息
uname -a
cat /etc/os-release

# 工具输出（保存到文件）
sudo python <工具> <参数> 2>&1 | tee output.log

# 网络信息
ip addr show
ip route show
ovs-vsctl show  # 如有 OVS
```

---

*最后更新：2024年*
