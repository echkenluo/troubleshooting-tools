# 第4章 扩展能力预览

本章介绍正在开发中的工具能力。这些工具尚未合入主线产品，但代表了完整的端到端测量能力建设方向。

---

## 4.1 工具发布状态

| 状态 | 说明 | 使用建议 |
|------|------|---------|
| **已发布** | 已合入 upstream-pr 分支，可在产品环境使用 | 正常使用 |
| **开发中** | 在 dev 分支，功能完整但未正式发布 | 需开发支持时可申请使用 |

---

## 4.2 已发布工具清单

以下工具已在 upstream-pr 分支发布：

### 路径跟踪与定界
- `icmp_path_tracer.py` - ICMP 路径跟踪
- `tcp_path_tracer.py` - TCP 路径跟踪
- `udp_path_tracer.py` - UDP 路径跟踪

### 延迟测量
- `system_network_icmp_rtt.py` - 系统网络 ICMP RTT
- `kernel_icmp_rtt.py` - 内核态 ICMP RTT
- `system_network_latency_summary.py` - 系统网络延迟统计
- `system_network_latency_details.py` - 系统网络延迟详情
- `vm_network_latency_summary.py` - VM 网络延迟统计
- `vm_network_latency_details.py` - VM 网络延迟详情

### 丢包检测
- `eth_drop.py` - 通用丢包检测
- `kernel_drop_stack_stats_summary.py` - 丢包栈统计
- `kernel_drop_stack_stats_summary_all.py` - 全量丢包栈统计

### OVS 相关
- `ovs_upcall_latency_summary.py` - OVS upcall 延迟
- `ovs_userspace_megaflow.py` - Megaflow 跟踪

### 虚拟化网络
- `vhost_queue_correlation_simple.py` - vhost 队列关联
- `kvm_irqfd_stats_summary.py` - KVM 中断统计

---

## 4.3 开发中工具预览

以下工具在 dev 分支，代表下一阶段能力：

### 4.3.1 TCP 性能深度分析

| 工具 | 功能 | 适用场景 |
|------|------|---------|
| `tcp_perf_observer.py` | TCP 连接性能观测 | TCP 传输性能问题 |
| `tcp_connection_analyzer.py` | TCP 连接状态分析 | 连接建立/关闭问题 |
| `tcp_rtt_inflight_hist.py` | TCP RTT 与 inflight 关系 | 拥塞分析 |
| `syscall_recv_latency_summary.py` | recv 系统调用延迟 | 应用层延迟分析 |

**能力说明**：
- 深入 TCP 协议栈内部状态
- 分析 RTT、重传、拥塞窗口等指标
- 定位 TCP 性能瓶颈

### 4.3.2 VXLAN 路径分析

| 工具 | 功能 | 适用场景 |
|------|------|---------|
| `vxlan_tracer.py` | VXLAN 封装/解封装跟踪 | VXLAN overlay 问题 |
| `skb_vxlan_source_detector.py` | VXLAN 包来源检测 | 包来源追溯 |
| `skb_frag_list_watcher.py` | SKB 分片链表监控 | 分片问题分析 |

**能力说明**：
- 跟踪 VXLAN 隧道的完整路径
- 分析封装/解封装性能
- 定位 overlay 网络问题

### 4.3.3 多 VM 对延迟分析

| 工具 | 功能 | 适用场景 |
|------|------|---------|
| `multi_vm_pair_latency.py` | 多 VM 对同时监控 | 批量 VM 延迟监控 |
| `multi_vm_pair_latency_pairid.py` | 带 Pair ID 的监控 | 大规模 VM 场景 |
| `vm_pair_gap.py` | VM 对延迟间隙分析 | 延迟突增检测 |
| `multi_vm_pair_multi_port_gap.py` | 多 VM 多端口间隙 | 复杂场景分析 |

**能力说明**：
- 同时监控多个 VM 对
- 检测延迟突增（gap）
- 支持大规模部署场景

### 4.3.4 vhost-net 深度分析

| 工具 | 功能 | 适用场景 |
|------|------|---------|
| `kvm_vhost_tun_latency_summary.py` | KVM-vhost-TUN 延迟统计 | 虚拟化网络栈延迟 |
| `kvm_vhost_tun_latency_details.py` | KVM-vhost-TUN 延迟详情 | 精确定位 |
| `tun_tx_to_kvm_irq.py` | TUN TX 到 KVM 中断延迟 | 中断注入延迟 |
| `vhost_wakeup_latency.py` | vhost 唤醒延迟 | vhost 调度问题 |

**能力说明**：
- 覆盖完整的 KVM 虚拟化网络路径
- 精确测量 vhost-net 处理延迟
- 分析中断注入性能

---

## 4.4 能力覆盖图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         网络数据路径覆盖                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  应用层                                                              │
│    │ syscall_recv_latency ←──────────────────────┐                  │
│    ↓                                              │                  │
│  Socket 层                                        │                  │
│    │ tcp_perf_observer, tcp_connection_analyzer  │ [开发中]         │
│    ↓                                              │                  │
│  TCP/IP 协议栈                                    │                  │
│    │ system_network_latency_*, kernel_icmp_rtt   │ [已发布]         │
│    ↓                                              │                  │
│  OVS 数据面                                       │                  │
│    │ ovs_upcall_latency, ovs_userspace_megaflow  │ [已发布]         │
│    ↓                                              │                  │
│  TUN/TAP                                          │                  │
│    │ tun_ring_monitor, tun_tx_to_kvm_irq         │ [部分已发布]     │
│    ↓                                              │                  │
│  vhost-net                                        │                  │
│    │ kvm_vhost_tun_latency_*, vhost_wakeup       │ [开发中]         │
│    ↓                                              │                  │
│  virtio-net (Guest)                              │                  │
│    │ virtnet_poll_monitor, virtnet_irq_monitor   │ [已发布]         │
│    ↓                                              │                  │
│  VM 应用                                          │                  │
│                                                                      │
├─────────────────────────────────────────────────────────────────────┤
│  丢包检测：eth_drop, *_path_tracer, kernel_drop_stack_stats        │
│  延迟测量：*_latency_summary, *_latency_details, *_icmp_rtt        │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4.5 如何获取开发中工具

如果遇到问题需要使用开发中的工具：

1. **联系开发团队**：说明问题场景和需求
2. **提供环境信息**：内核版本、系统版本
3. **配合测试**：开发团队可能需要远程协助部署和调试

**注意事项**：
- 开发中工具可能存在兼容性问题
- 需要开发团队支持使用
- 使用结果可帮助推动工具正式发布
