# 第4章 扩展能力预览

本章介绍工具的发布状态和完整的数据路径覆盖。

---

## 4.1 工具发布状态

| 状态             | 说明                                                            | 使用建议               |
| ---------------- | --------------------------------------------------------------- | ---------------------- |
| **已发布** | 已合入  everoute/troubleshooting-tools repo，可在产品环境使用  | 正常使用               |
| **开发中** | 在  echkenluo/troubleshooting-tools repo，功能完整但未正式发布 | 需开发支持时可申请使用 |

---

## 4.2 已发布工具清单

以下工具已在 upstream-pr 分支发布：

### 路径跟踪与定界

- `icmp_path_tracer.py` - ICMP 路径跟踪（丢包/延迟定界）
- `tcp_path_tracer.py` - TCP 路径跟踪（支持 stats/verbose 双模式）
- `udp_path_tracer.py` - UDP 路径跟踪（支持 stats/verbose 双模式，含分片组跟踪）

### 延迟测量

- `system_network_icmp_rtt.py` - 系统网络 ICMP RTT（含 OVS 路径分段）
- `kernel_icmp_rtt.py` - 内核态 ICMP RTT（不含 OVS）
- `system_network_latency_summary.py` - 系统网络延迟直方图
- `system_network_latency_details.py` - 系统网络延迟逐包详情
- `vm_network_latency_summary.py` - VM 网络延迟直方图
- `vm_network_latency_details.py` - VM 网络延迟逐包详情

### 综合性能

- `system_network_perfomance_metrics.py` - 系统网络综合性能指标
- `vm_network_performance_metrics.py` - VM 网络综合性能指标

### 丢包检测

- `eth_drop.py` - 通用丢包检测（含调用栈）
- `kernel_drop_stack_stats_summary_all.py` - 全量丢包栈统计（五元组粒度）
- `qdisc_drop_trace.py` - qdisc 队列层丢包跟踪

### OVS 相关

- `ovs_upcall_latency_summary.py` - OVS upcall 延迟
- `ovs_userspace_megaflow.py` - Megaflow 跟踪
- `ovs-kernel-module-drop-monitor.py` - OVS 内核模块丢包监控
- `ovs_mcast_action_trace.py` - OVS 多播 action 跟踪

### 内核协议栈

- `trace_conntrack.py` - conntrack 连接跟踪
- `trace_ip_defrag.py` - IP 分片/重组跟踪

### KVM 虚拟化网络

- `kvm_irqfd_stats_summary.py` - KVM 中断统计（x86）
- `kvm_irqfd_stats_summary_arm.py` - KVM 中断统计（ARM）
- `vhost_queue_correlation_simple.py` - vhost 队列关联（简单）
- `vhost_queue_correlation_details.py` - vhost 队列关联（详细）
- `vhost_buf_peek_stats.py` - vhost buffer 统计
- `tun_ring_monitor.py` - TUN 环形缓冲区监控
- `tun_to_vhost_queue_stats_full_summary.py` - TUN 到 vhost 队列统计
- `tun_to_vhost_queue_status_simple_summary.py` - TUN 到 vhost 队列状态
- `virtnet_poll_monitor.py` - virtio-net polling 监控
- `virtnet_irq_monitor.py` - virtio-net 中断监控

### CPU / 调度

- `offcputime-ts.py` - Off-CPU 时间时序信息测量

### 其他

- `drop_monitor_controller.py` - 丢包监控控制器
- `deploy_full_mesh_icmp_tracer.py` - 系统网络 system_network_icmp_rtt 集群范围自动部署工具

---

## 4.3 未发布工具预览

以下工具在 dev 分支，代表当前可用，但未大规模全平台/架构覆盖测试的能力：

### 4.3.1 TCP 性能深度分析

| 工具                                | 功能                                 | 适用场景               |
| ----------------------------------- | ------------------------------------ | ---------------------- |
| `tcp_perf_observer.py`            | TCP RTT、握手、拥塞控制监控          | TCP 传输性能问题       |
| `tcp_connection_analyzer.py`      | TCP 连接状态和瓶颈检测               | 连接建立/关闭问题      |
| `tcp_rtt_inflight_hist.py`        | TCP RTT 与 inflight 关系（接收视角） | tcp 延迟/拥塞/窗口分析 |
| `tcp_send_rtt_inflight_hist.py`   | TCP RTT 与 inflight 关系（发送视角） | tcp 延迟/拥塞/窗口分析 |
| `syscall_recv_latency_summary.py` | recv 系统调用延迟                    | 应用层延迟分析         |

### 4.3.2 vhost-net / KVM 深度分析

| 工具                                      | 功能                   | 适用场景                                |
| ----------------------------------------- | ---------------------- | --------------------------------------- |
| `kvm_vhost_tun_latency_summary.py`      | KVM-vhost-TUN 延迟统计 | 虚拟化网络栈延迟分布统计                |
| `kvm_vhost_tun_latency_details.py`      | KVM-vhost-TUN 延迟详情 | 需两阶段运行，discover 阶段数据结构发现 |
| `kvm_vhost_tun_latency_no_discovery.py` | KVM-vhost-TUN 延迟详情 | 同上，单阶段，无需内核数据结构发现版本  |
| `tun_tx_to_kvm_irq.py`                  | TUN TX 到 KVM 中断延迟 | tun 设备 到 kvm 中断注入延迟分布        |
| `vhost_wakeup_latency.py`               | vhost 唤醒延迟         | vhost 调度问题                          |

### 4.3.3 OVS Internal Port 等 interface 软中断分析

| 工具                                                   | 功能                      | 适用场景               |
| ------------------------------------------------------ | ------------------------- | ---------------------- |
| `enqueue_to_iprec_latency_summary.py`                | Internal port RX 延迟     | OVS internal port 延迟 |
| `enqueue_to_iprec_latency_threshold.py`              | 阈值触发 RX 延迟分析      | 异常延迟捕获           |
| `ksoftirqd_sched_latency_summary.py`                 | ksoftirqd 调度延迟        | 软中断调度问题         |
| `system_network_rx_internal_port_latency_details.py` | Internal port RX 延迟详情 | 精确定位               |

### 4.3.4 其他

| 工具                                | 功能                 | 适用场景       |
| ----------------------------------- | -------------------- | -------------- |
| `deploy_full_mesh_icmp_tracer.py` | 全网格 ICMP RTT 部署 | 多节点延迟测量 |
| `qdisc_lateny_details.py`         | qdisc 包顺序跟踪     | 队列调度分析   |
| `skb_frag_list_watcher.py`        | SKB 分片链表监控     | 分片问题分析   |

---

## 4.4 能力覆盖图

```
┌──────────────────────────────────────────────────────────────────┐
│                        网络数据路径覆盖                            │
├──────────────────────────────────────────────────────────────────┤
│                                                                    │
│  应用层                                                            │
│    │ syscall_recv_latency                                [dev]    │
│    ↓                                                               │
│  Socket / TCP 层                                                   │
│    │ tcp_perf_observer, tcp_connection_analyzer           [dev]    │
│    │ tcp_rtt_inflight_hist                                [dev]    │
│    ↓                                                               │
│  TCP/IP 协议栈                                                     │
│    │ system_network_latency_*, kernel_icmp_rtt            [发布]   │
│    │ trace_conntrack, trace_ip_defrag                     [发布]   │
│    ↓                                                               │
│  OVS 数据面                                                        │
│    │ ovs_upcall_latency, ovs_userspace_megaflow           [发布]   │
│    │ ovs-kernel-module-drop-monitor                       [发布]   │
│    │ enqueue_to_iprec_latency, ksoftirqd_sched_latency    [dev]    │
│    ↓                                                               │
│  TUN/TAP                                                           │
│    │ tun_ring_monitor, tun_to_vhost_queue_stats           [发布]   │
│    │ tun_tx_to_kvm_irq                                    [dev]    │
│    ↓                                                               │
│  vhost-net                                                         │
│    │ vhost_queue_correlation_*, vhost_buf_peek_stats       [发布]   │
│    │ kvm_vhost_tun_latency_*, vhost_wakeup_latency        [dev]    │
│    ↓                                                               │
│  KVM                                                               │
│    │ kvm_irqfd_stats_summary                              [发布]   │
│    ↓                                                               │
│  virtio-net (Guest)                                                │
│    │ virtnet_poll_monitor, virtnet_irq_monitor             [发布]   │
│    ↓                                                               │
│  VM 应用                                                           │
│                                                                    │
├──────────────────────────────────────────────────────────────────┤
│  定界：icmp/tcp/udp_path_tracer, *_icmp_rtt                      │
│  丢包：eth_drop, kernel_drop_stack_stats, qdisc_drop_trace        │
│  延迟：*_latency_summary, *_latency_details                       │
│  性能：*_performance_metrics, vm_pair_latency, vm_pair_gap         │
│  CPU ：offcputime-ts, ksoftirqd_sched_latency                     │
└──────────────────────────────────────────────────────────────────┘
```

---

## 4.5 如何获取开发中工具

如果遇到问题需要使用开发中的工具：

1. **联系开发团队**：说明问题场景和需求
2. **提供环境信息**：内核版本、系统版本
3. **配合测试**：开发团队可能需要远程协助部署和调试

**注意事项**：

- 开发中工具可能存在兼容性问题
- 需要开发团队支持使用
- 使用结果可帮助推动工具正式发布
