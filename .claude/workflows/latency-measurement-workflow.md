# Latency Measurement Workflow

## Overview

This workflow orchestrates end-to-end latency measurement and analysis for cross-node VM ICMP ping. It coordinates remote execution of measurement tools, log collection, and triggers the `latency-analysis` skill for analysis.

## Prerequisites

- SSH access to sender/receiver VMs and hosts
- Measurement tools deployed to target machines:
  - `kernel_icmp_rtt.py` on VMs
  - `icmp_drop_detector.py` on hosts
  - `tun_tx_to_kvm_irq.py` on hosts
- Root/sudo access on target machines

## Workflow Steps

### Step 1: Environment Configuration

Collect environment information from user:

```yaml
environment:
  name: "Environment Name"

sender:
  vm:
    ssh: "user@sender-vm-ip"
    ip: "10.x.x.x"
  host:
    ssh: "user@sender-host-ip"
    vnet_interface: "vnet0"
    phy_interface: "eth0"

receiver:
  vm:
    ssh: "user@receiver-vm-ip"
    ip: "10.x.x.y"
  host:
    ssh: "user@receiver-host-ip"
    vnet_interface: "vnet0"
    phy_interface: "eth0"

tools:
  kernel_icmp_rtt: "/path/to/kernel_icmp_rtt.py"
  icmp_drop_detector: "/path/to/icmp_drop_detector.py"
  tun_tx_to_kvm_irq: "/path/to/tun_tx_to_kvm_irq.py"

measurement:
  duration: 60  # seconds
  ping_count: 50
```

### Step 2: Deploy Tools (if needed)

If tools are not already on target machines, deploy them:

```bash
# Copy tools to target machines
scp measurement-tools/performance/system-network/kernel_icmp_rtt.py user@vm:/tmp/
scp measurement-tools/performance/system-network/icmp_drop_detector.py user@host:/tmp/
scp measurement-tools/kvm-virt-network/tun/tun_tx_to_kvm_irq.py user@host:/tmp/
```

### Step 3: Start Measurement Tools

Start tools on all machines in parallel. Use `testing-agent` for remote execution.

**Order of operations** (tools should be started before ping):

1. Start receivers first (they wait for packets):
   - Receiver VM: `kernel_icmp_rtt.py`
   - Receiver Host: `icmp_drop_detector.py`
   - Receiver Host: `tun_tx_to_kvm_irq.py`

2. Start sender-side tools:
   - Sender Host: `icmp_drop_detector.py`
   - Sender Host: `tun_tx_to_kvm_irq.py`
   - Sender VM: `kernel_icmp_rtt.py`

3. Start ping from sender VM (or sender VM tool starts ping internally)

**Commands**:

```bash
# Sender VM
ssh user@sender-vm "sudo python /tmp/kernel_icmp_rtt.py \
    --src-ip ${SENDER_IP} --dst-ip ${RECEIVER_IP}" > sfsvm-send.log &

# Receiver VM
ssh user@receiver-vm "sudo python /tmp/kernel_icmp_rtt.py \
    --src-ip ${SENDER_IP} --dst-ip ${RECEIVER_IP}" > sfsvm-recv.log &

# Sender Host
ssh user@sender-host "sudo python /tmp/icmp_drop_detector.py \
    --src-ip ${SENDER_IP} --dst-ip ${RECEIVER_IP} \
    --phy-interface ${PHY_IF} --vm-interface ${VNET_IF}" > host-send.log &

# Receiver Host
ssh user@receiver-host "sudo python /tmp/icmp_drop_detector.py \
    --src-ip ${SENDER_IP} --dst-ip ${RECEIVER_IP} \
    --phy-interface ${PHY_IF} --vm-interface ${VNET_IF}" > host-recv.log &

# Receiver Host vhost (for request packets)
ssh user@receiver-host "sudo python /tmp/tun_tx_to_kvm_irq.py \
    --vm-interface ${VNET_IF} --direction rx" > vhost-recv-request.log &

# Sender Host vhost (for reply packets)
ssh user@sender-host "sudo python /tmp/tun_tx_to_kvm_irq.py \
    --vm-interface ${VNET_IF} --direction rx" > vhost-send-reply.log &
```

### Step 4: Run Ping Test

Start ping from sender VM:

```bash
ssh user@sender-vm "ping -c ${PING_COUNT} ${RECEIVER_IP}"
```

### Step 5: Stop Tools and Collect Logs

After measurement duration, stop all tools and collect logs:

```bash
# Stop tools (Ctrl+C or kill)
ssh user@sender-vm "pkill -f kernel_icmp_rtt.py"
# ... repeat for all tools

# Collect logs to local machine
scp user@sender-vm:/tmp/sfsvm-send.log ./
scp user@receiver-vm:/tmp/sfsvm-recv.log ./
# ... collect all logs
```

### Step 6: Trigger Analysis

Invoke the `latency-analysis` skill with collected logs:

```
Analyze the following latency logs:
- Sender VM: sfsvm-send.log
- Receiver VM: sfsvm-recv.log
- Sender Host: host-send.log
- Receiver Host: host-recv.log
- Receiver vhost: vhost-recv-request.log
- Sender vhost: vhost-send-reply.log

Environment: [Environment Name]
```

## Integration with testing-agent

The `testing-agent` can execute remote commands. Example usage:

```yaml
# Test configuration for testing-agent
test_config:
  remote_hosts:
    - name: sender-vm
      ssh: user@sender-vm-ip
      commands:
        - "sudo python /tmp/kernel_icmp_rtt.py --src-ip X --dst-ip Y"
    - name: receiver-vm
      ssh: user@receiver-vm-ip
      commands:
        - "sudo python /tmp/kernel_icmp_rtt.py --src-ip X --dst-ip Y"
    # ... other hosts
```

## Output

This workflow produces:
1. Six log files with raw measurement data
2. Analysis report (generated by latency-analysis skill)

## Comparison Workflow

For comparing two environments:

1. Run measurement workflow on Environment A
2. Save logs with prefix (e.g., `env-a-sfsvm-send.log`)
3. Run measurement workflow on Environment B
4. Save logs with prefix (e.g., `env-b-sfsvm-send.log`)
5. Trigger analysis with both sets of logs for comparison

## Troubleshooting

### Tools not capturing packets

- Verify IP addresses are correct
- Check that ping is running
- Verify interface names
- Check BPF program loaded correctly (`bpftool prog list`)

### Permission denied

- Ensure sudo/root access
- Check BPF permissions

### Missing output

- Check tool stderr for errors
- Verify network connectivity between VMs
- Check firewall rules
